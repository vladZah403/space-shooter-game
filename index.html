<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Space Shooter</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --green:#00ff88;--cyan:#00d4ff;--pink:#ff0066;--gold:#ffd700;--purple:#a855f7;
  --bg:#04040f;--card:rgba(8,18,35,.95);--border:rgba(0,255,136,.25);
}
body{overflow:hidden;background:var(--bg);font-family:'Rajdhani',sans-serif;touch-action:none;user-select:none}
#gameCanvas{display:block;touch-action:none;position:absolute;inset:0}

/* â”€â”€ PAUSE OVERLAY â”€â”€ */
#pauseOverlay{position:absolute;inset:0;background:rgba(4,4,15,.85);display:none;align-items:center;justify-content:center;z-index:50;backdrop-filter:blur(16px)}
.pause-card{background:var(--card);border:1.5px solid var(--border);border-radius:20px;padding:32px 28px;text-align:center;min-width:240px;box-shadow:0 0 60px rgba(0,255,136,.15)}
.pause-title{font-family:'Orbitron',monospace;font-size:28px;color:var(--green);text-shadow:0 0 20px var(--green);margin-bottom:24px;letter-spacing:4px}
.pause-btn{display:block;width:100%;background:linear-gradient(135deg,var(--green),var(--cyan));border:none;color:#04040f;font-family:'Orbitron',monospace;font-weight:700;font-size:13px;padding:12px;border-radius:40px;cursor:pointer;letter-spacing:2px;margin-bottom:10px;transition:all .2s}
.pause-btn:active{transform:scale(.95)}
.pause-btn.secondary{background:transparent;border:1.5px solid var(--border);color:var(--green);font-size:12px}

/* â”€â”€ UI TOP â”€â”€ */
#ui{position:absolute;top:0;left:0;right:0;z-index:10;pointer-events:none;padding:10px}
.stats-row{display:flex;gap:6px;align-items:stretch}
.stat-pill{background:rgba(8,18,35,.88);border:1px solid var(--border);border-radius:10px;padding:5px 10px;backdrop-filter:blur(10px);flex:1;position:relative;overflow:hidden}
.stat-pill::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(0,255,136,.05),transparent);pointer-events:none}
.stat-lbl{font-size:8px;color:rgba(0,255,136,.5);text-transform:uppercase;letter-spacing:1px;font-family:'Orbitron',monospace}
.stat-val{font-size:17px;font-weight:700;color:var(--green);font-family:'Orbitron',monospace;line-height:1.1;text-shadow:0 0 8px rgba(0,255,136,.5)}
.stat-val.lives{color:#ff6b88;text-shadow:0 0 8px rgba(255,107,136,.5)}
.stat-val.level-val{color:var(--cyan);text-shadow:0 0 8px rgba(0,212,255,.5)}

/* Level progress */
#levelBar{height:3px;background:rgba(0,212,255,.1);border-radius:2px;overflow:hidden;margin-top:6px}
#levelFill{height:100%;background:linear-gradient(90deg,var(--cyan),var(--green));border-radius:2px;transition:width .4s ease;box-shadow:0 0 6px var(--cyan)}

/* XP bar */
#xpRow{display:flex;align-items:center;gap:8px;margin-top:5px;padding:4px 8px;background:rgba(255,215,0,.06);border-radius:8px;border:1px solid rgba(255,215,0,.1)}
.xp-lbl{font-size:9px;color:rgba(255,215,0,.6);font-family:'Orbitron',monospace;white-space:nowrap}
.xp-track{flex:1;height:3px;background:rgba(255,215,0,.1);border-radius:2px;overflow:hidden}
.xp-fill-bar{height:100%;background:linear-gradient(90deg,var(--gold),#ff9900);border-radius:2px;transition:width .4s}
.xp-lvl{font-size:10px;color:var(--gold);font-family:'Orbitron',monospace;white-space:nowrap}

/* â”€â”€ PAUSE BTN â”€â”€ */
#pauseBtn{position:absolute;top:10px;right:10px;z-index:15;pointer-events:all;width:38px;height:38px;background:rgba(8,18,35,.88);border:1px solid var(--border);border-radius:10px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;backdrop-filter:blur(10px)}
#pauseBtn:active{transform:scale(.9);border-color:var(--green)}
#pauseBtn svg{width:16px;height:16px;fill:var(--green)}

/* â”€â”€ COMBO â”€â”€ */
#comboDisplay{position:absolute;top:105px;right:10px;text-align:right;pointer-events:none;z-index:10;transition:opacity .3s,transform .3s}
.combo-word{font-size:9px;color:rgba(255,215,0,.7);font-family:'Orbitron',monospace;letter-spacing:2px}
.combo-num{font-size:32px;font-weight:900;color:var(--gold);font-family:'Orbitron',monospace;text-shadow:0 0 20px rgba(255,215,0,.6);line-height:1;animation:comboPulse .3s ease}
@keyframes comboPulse{0%{transform:scale(1.3)}100%{transform:scale(1)}}
.combo-hidden{opacity:0;transform:translateX(20px)}

/* â”€â”€ NOTIFICATIONS â”€â”€ */
#notifications{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);z-index:20;pointer-events:none;text-align:center}
.notif{font-size:20px;font-weight:700;font-family:'Orbitron',monospace;color:var(--green);text-shadow:0 0 15px var(--green);animation:notifAnim .9s forwards;white-space:nowrap}
.notif.boss{font-size:28px;color:var(--pink);text-shadow:0 0 30px var(--pink)}
.notif.gold{color:var(--gold);text-shadow:0 0 15px var(--gold);font-size:16px}
.notif.levelup{font-size:26px;color:var(--cyan);text-shadow:0 0 25px var(--cyan)}
@keyframes notifAnim{0%{opacity:0;transform:scale(.4) translateY(0)}20%{opacity:1;transform:scale(1.1) translateY(0)}60%{opacity:1;transform:scale(1) translateY(-10px)}100%{opacity:0;transform:scale(.8) translateY(-45px)}}

/* â”€â”€ POWERUP BAR â”€â”€ */
#powerupBar{position:absolute;bottom:72px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:10;pointer-events:none}
.pu-chip{background:rgba(8,18,35,.88);border:1.5px solid;border-radius:20px;padding:4px 12px;font-size:11px;font-weight:700;font-family:'Orbitron',monospace;display:flex;align-items:center;gap:5px}
.pu-chip.shield{border-color:var(--cyan);color:var(--cyan);box-shadow:0 0 12px rgba(0,212,255,.3)}
.pu-chip.speed{border-color:var(--gold);color:var(--gold);box-shadow:0 0 12px rgba(255,215,0,.3)}

/* â”€â”€ BOSS BAR â”€â”€ */
#bossBar{position:absolute;bottom:72px;left:10px;right:10px;z-index:10;display:none;pointer-events:none}
.boss-lbl{font-size:10px;color:var(--pink);text-align:center;margin-bottom:4px;font-family:'Orbitron',monospace;letter-spacing:2px;text-shadow:0 0 10px var(--pink);animation:bossNamePulse 1.5s infinite}
@keyframes bossNamePulse{0%,100%{opacity:1;text-shadow:0 0 10px var(--pink)}50%{opacity:.7;text-shadow:0 0 20px var(--pink),0 0 40px var(--pink)}}
.boss-track{height:8px;background:rgba(255,0,102,.1);border-radius:6px;border:1px solid rgba(255,0,102,.3);overflow:hidden}
#bossFill{height:100%;background:linear-gradient(90deg,var(--pink),#ff6b00);border-radius:6px;transition:width .3s;box-shadow:0 0 8px rgba(255,0,102,.6)}

/* â”€â”€ AUTO / WEAPON BAR â”€â”€ */
#bottomBar{position:absolute;bottom:12px;left:10px;right:10px;display:flex;align-items:center;justify-content:space-between;z-index:10;pointer-events:all}
.weapon-btn{width:50px;height:50px;background:rgba(8,18,35,.88);border:2px solid rgba(0,255,136,.2);border-radius:12px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;gap:1px;backdrop-filter:blur(8px)}
.weapon-btn.active{border-color:var(--green);background:rgba(0,255,136,.12);box-shadow:0 0 16px rgba(0,255,136,.3)}
.weapon-btn:active{transform:scale(.88)}
.weapon-emoji{font-size:18px;line-height:1}
.weapon-lbl{font-size:7px;color:rgba(0,255,136,.6);font-family:'Orbitron',monospace;font-weight:700}
.weapon-btn.active .weapon-lbl{color:var(--green)}
.weapons-group{display:flex;gap:6px}
#autoBtn{background:rgba(8,18,35,.88);border:1.5px solid rgba(0,255,136,.3);border-radius:20px;padding:8px 14px;color:rgba(0,255,136,.6);font-size:10px;font-family:'Orbitron',monospace;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px;backdrop-filter:blur(8px)}
#autoBtn.active{background:rgba(0,255,136,.15);border-color:var(--green);color:var(--green);box-shadow:0 0 12px rgba(0,255,136,.25)}
#autoBtn:active{transform:scale(.93)}

/* â”€â”€ ACHIEVEMENT TOAST â”€â”€ */
#achieveToast{position:absolute;top:80px;left:50%;transform:translateX(-50%);background:rgba(8,18,35,.96);border:1.5px solid var(--gold);border-radius:14px;padding:10px 20px;display:none;z-index:25;text-align:center;box-shadow:0 0 30px rgba(255,215,0,.3);backdrop-filter:blur(10px);animation:slideDown .4s ease}
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
.ach-lbl{font-size:8px;color:rgba(255,215,0,.6);font-family:'Orbitron',monospace;letter-spacing:3px;margin-bottom:2px}
.ach-name{font-size:14px;font-weight:700;color:var(--gold);font-family:'Orbitron',monospace}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.screen{position:absolute;inset:0;background:rgba(4,4,15,.97);display:none;align-items:center;justify-content:center;z-index:30;backdrop-filter:blur(16px);padding:12px;overflow-y:auto}
.screen.active{display:flex}

/* Common card */
.card{background:var(--card);border:1.5px solid var(--border);border-radius:20px;padding:20px 16px;max-width:400px;width:100%;box-shadow:0 10px 60px rgba(0,255,136,.12);max-height:94vh;overflow-y:auto}

/* Screen titles */
.screen-title{font-family:'Orbitron',monospace;font-size:28px;font-weight:900;text-align:center;margin-bottom:2px;line-height:1.1}
.screen-title.green{background:linear-gradient(135deg,var(--green),var(--cyan));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.screen-title.gold{background:linear-gradient(135deg,var(--gold),#ff9900);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.screen-title.purple{background:linear-gradient(135deg,var(--purple),#ec4899);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.screen-title.cyan{background:linear-gradient(135deg,var(--cyan),var(--purple));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.screen-sub{text-align:center;font-size:9px;color:rgba(0,255,136,.4);font-family:'Orbitron',monospace;letter-spacing:3px;margin-bottom:18px}

/* Buttons */
.btn{border:none;cursor:pointer;font-family:'Orbitron',monospace;font-weight:700;letter-spacing:1.5px;border-radius:40px;transition:all .2s;display:block;width:100%;text-align:center}
.btn:active{transform:scale(.95)}
.btn-primary{background:linear-gradient(135deg,var(--green),var(--cyan));color:#04040f;font-size:14px;padding:13px;box-shadow:0 4px 20px rgba(0,255,136,.35)}
.btn-primary:disabled{background:rgba(255,255,255,.08);color:rgba(255,255,255,.25);cursor:not-allowed;box-shadow:none}
.btn-secondary{background:transparent;border:1.5px solid var(--border);color:var(--green);font-size:11px;padding:10px}
.btn-gold{border-color:rgba(255,215,0,.4);color:var(--gold)}
.btn-cyan{border-color:rgba(0,212,255,.4);color:var(--cyan)}
.btn-purple{border-color:rgba(168,85,247,.4);color:var(--purple)}
.btn-red{border-color:rgba(255,0,102,.4);color:var(--pink)}

/* â”€â”€ DIFFICULTY SCREEN â”€â”€ */
.diff-item{background:rgba(8,18,35,.6);border:1.5px solid rgba(0,255,136,.15);border-radius:14px;padding:12px 14px;margin-bottom:8px;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:12px}
.diff-item:active{transform:scale(.97)}
.diff-item.selected{border-color:var(--green);background:rgba(0,255,136,.1);box-shadow:0 0 20px rgba(0,255,136,.15)}
.diff-icon{font-size:28px;flex-shrink:0}
.diff-name{font-size:16px;font-weight:700;color:var(--green);font-family:'Orbitron',monospace;margin-bottom:2px}
.diff-desc{font-size:11px;color:rgba(255,255,255,.55)}
.diff-badge{font-size:9px;padding:2px 8px;border-radius:10px;border:1px solid;margin-left:6px;font-family:'Orbitron',monospace;vertical-align:middle}
.diff-badge.nm{color:var(--pink);border-color:var(--pink)}

.check-row{display:flex;align-items:center;gap:8px;padding:8px 4px;cursor:pointer;margin:8px 0}
.check-row input[type=checkbox]{width:16px;height:16px;accent-color:var(--green)}
.check-row label{color:var(--green);font-size:12px;font-family:'Rajdhani',sans-serif;cursor:pointer}

.menu-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px}
.menu-grid .btn{font-size:10px;padding:10px 6px}

/* â”€â”€ GAME OVER SCREEN â”€â”€ */
.score-block{background:rgba(8,18,35,.7);border:1px solid rgba(0,255,136,.15);border-radius:12px;padding:12px 14px;margin-bottom:8px}
.score-lbl{font-size:10px;color:rgba(0,255,136,.55);font-family:'Orbitron',monospace;letter-spacing:1px}
.score-val{font-size:26px;font-weight:900;color:var(--green);font-family:'Orbitron',monospace;text-shadow:0 0 12px rgba(0,255,136,.4)}
.score-val.record{color:var(--gold);text-shadow:0 0 12px rgba(255,215,0,.4)}
.new-record{display:inline-block;font-size:9px;color:var(--gold);border:1px solid var(--gold);border-radius:10px;padding:1px 8px;font-family:'Orbitron',monospace;margin-left:6px;animation:blink 1s infinite}
@keyframes blink{50%{opacity:.3}}
.ach-badges{display:flex;flex-wrap:wrap;gap:5px;margin:10px 0}
.ach-badge{font-size:10px;padding:3px 10px;border-radius:12px;border:1px solid;font-family:'Rajdhani',sans-serif;font-weight:700}
.ach-badge.unlocked{color:var(--gold);border-color:rgba(255,215,0,.5);background:rgba(255,215,0,.08)}
.ach-badge.locked{color:rgba(255,255,255,.25);border-color:rgba(255,255,255,.1)}
.coins-earned{text-align:center;color:var(--gold);font-size:13px;font-family:'Orbitron',monospace;padding:8px;background:rgba(255,215,0,.06);border-radius:10px;margin-bottom:10px;border:1px solid rgba(255,215,0,.15)}

/* â”€â”€ UPGRADE SCREEN â”€â”€ */
.coins-banner{text-align:center;color:var(--gold);font-size:16px;font-family:'Orbitron',monospace;margin-bottom:14px;padding:8px;background:rgba(255,215,0,.07);border-radius:10px;border:1px solid rgba(255,215,0,.2)}
.upg-item{background:rgba(8,18,35,.6);border:1.5px solid rgba(255,215,0,.15);border-radius:14px;padding:13px;margin-bottom:9px;display:flex;align-items:center;gap:10px;transition:all .2s}
.upg-item.maxed{border-color:rgba(0,255,136,.3)}
.upg-icon{font-size:26px;flex-shrink:0}
.upg-name{font-size:13px;font-weight:700;color:var(--gold);font-family:'Orbitron',monospace;margin-bottom:1px}
.upg-desc{font-size:10px;color:rgba(255,255,255,.5);margin-bottom:5px}
.upg-stars{display:flex;gap:3px;margin-bottom:0}
.star{width:11px;height:11px;border-radius:2px;background:rgba(255,215,0,.1);border:1px solid rgba(255,215,0,.25)}
.star.on{background:var(--gold);border-color:var(--gold);box-shadow:0 0 4px rgba(255,215,0,.5)}
.upg-btn{background:linear-gradient(135deg,var(--gold),#ff9900);border:none;color:#04040f;font-weight:700;font-size:11px;font-family:'Orbitron',monospace;padding:7px 12px;border-radius:20px;cursor:pointer;white-space:nowrap;flex-shrink:0;transition:all .2s}
.upg-btn:active{transform:scale(.93)}
.upg-btn:disabled{background:rgba(255,255,255,.08);color:rgba(255,255,255,.25);cursor:not-allowed}
.upg-btn.maxed{background:linear-gradient(135deg,var(--green),var(--cyan));color:#04040f}

/* â”€â”€ LEADERBOARD â”€â”€ */
.lb-row{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;margin-bottom:6px;background:rgba(8,18,35,.5);border:1px solid rgba(0,212,255,.12);transition:all .2s}
.lb-row.me{border-color:rgba(0,255,136,.4);background:rgba(0,255,136,.07)}
.lb-rank{font-size:18px;font-family:'Orbitron',monospace;font-weight:900;min-width:30px;text-align:center}
.lb-info{flex:1;overflow:hidden}
.lb-name{font-size:13px;font-weight:700;color:#fff;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.lb-sub{font-size:10px;color:rgba(255,255,255,.35)}
.lb-score{font-size:15px;font-weight:700;color:var(--cyan);font-family:'Orbitron',monospace}
.lb-loading{text-align:center;color:rgba(0,212,255,.5);font-size:12px;padding:20px;font-family:'Orbitron',monospace;letter-spacing:1px}

/* â”€â”€ CUSTOMIZE SCREEN â”€â”€ */
.cust-section{margin-bottom:16px}
.cust-lbl{color:var(--green);font-size:12px;font-family:'Orbitron',monospace;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:6px;letter-spacing:1px}
.color-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:6px}
.color-opt{aspect-ratio:1;border-radius:10px;border:2px solid rgba(0,255,136,.15);cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;position:relative}
.color-opt i{position:absolute;color:#fff;font-size:14px;opacity:0;transition:opacity .2s;text-shadow:0 1px 4px #0008}
.color-opt.sel{border-color:var(--green);box-shadow:0 0 14px rgba(0,255,136,.4);transform:scale(1.08)}
.color-opt.sel i{opacity:1}
.color-opt:active{transform:scale(.92)}
.shape-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.shape-opt{background:rgba(8,18,35,.6);border:1.5px solid rgba(0,255,136,.15);border-radius:12px;padding:10px 6px;cursor:pointer;transition:all .2s;text-align:center}
.shape-opt:active{transform:scale(.94)}
.shape-opt.sel{border-color:var(--green);background:rgba(0,255,136,.12)}
.shape-name{color:var(--green);font-size:11px;font-family:'Orbitron',monospace;font-weight:700;margin-bottom:2px}
.shape-desc{color:rgba(255,255,255,.45);font-size:9px}
.style-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.style-opt{background:rgba(8,18,35,.6);border:1.5px solid rgba(0,255,136,.15);border-radius:12px;padding:10px 6px;cursor:pointer;transition:all .2s;text-align:center}
.style-opt:active{transform:scale(.94)}
.style-opt.sel{border-color:var(--green);background:rgba(0,255,136,.12)}
.style-name{color:var(--green);font-size:11px;font-family:'Orbitron',monospace;font-weight:700;margin-bottom:2px}
.style-desc{color:rgba(255,255,255,.45);font-size:9px}
.toggle-row{display:flex;align-items:center;gap:8px;padding:6px 0;cursor:pointer}
.toggle-row input{width:16px;height:16px;accent-color:var(--green)}
.toggle-row label{color:var(--green);font-size:12px;cursor:pointer}

/* â”€â”€ SKIN SCREEN â”€â”€ */
.skin-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px}
.skin-item{background:rgba(8,18,35,.6);border:2px solid rgba(168,85,247,.15);border-radius:14px;padding:14px 10px;cursor:pointer;transition:all .2s;text-align:center;position:relative}
.skin-item.ok{border-color:rgba(168,85,247,.4)}
.skin-item.active{border-color:var(--purple);background:rgba(168,85,247,.12);box-shadow:0 0 18px rgba(168,85,247,.25)}
.skin-item.locked{opacity:.45;cursor:not-allowed}
.skin-icon{font-size:36px;margin-bottom:5px;display:block}
.skin-name{font-size:12px;font-weight:700;color:var(--purple);font-family:'Orbitron',monospace;margin-bottom:3px}
.skin-req{font-size:9px;color:rgba(255,255,255,.4)}
.skin-unlocked{font-size:9px;color:var(--green)}
.skin-active-badge{position:absolute;top:6px;right:6px;font-size:9px;background:rgba(0,255,136,.15);border:1px solid var(--green);border-radius:8px;padding:1px 6px;color:var(--green);font-family:'Orbitron',monospace}

/* â”€â”€ TOUCH HINT â”€â”€ */
.touch-hint{position:absolute;bottom:82px;left:50%;transform:translateX(-50%);color:rgba(0,255,136,.4);font-size:11px;font-family:'Orbitron',monospace;text-align:center;pointer-events:none;z-index:5;animation:fadeOut 4s ease forwards;letter-spacing:1px;white-space:nowrap}
@keyframes fadeOut{0%,60%{opacity:1}100%{opacity:0}}

/* â”€â”€ SCROLLBAR â”€â”€ */
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(0,255,136,.25);border-radius:2px}
::-webkit-scrollbar-thumb:hover{background:rgba(0,255,136,.45)}

/* â”€â”€ FLEX UTILS â”€â”€ */
.flex{display:flex}.gap2{gap:8px}.mt1{margin-top:8px}.mt2{margin-top:12px}.mt3{margin-top:16px}.w100{width:100%}.grow{flex:1}
</style>
</head>
<body>

<!-- â•â•â• CANVAS â•â•â• -->
<canvas id="gameCanvas"></canvas>

<!-- â•â•â• PAUSE OVERLAY â•â•â• -->
<div id="pauseOverlay">
  <div class="pause-card">
    <div class="pause-title">ĞŸĞĞ£Ğ—Ğ</div>
    <button class="pause-btn" id="resumeBtn">â–¶ ĞŸĞ ĞĞ”ĞĞ›Ğ–Ğ˜Ğ¢Ğ¬</button>
    <button class="pause-btn secondary" id="pauseRestartBtn">â†º Ğ—ĞĞĞĞ’Ğ</button>
    <button class="pause-btn secondary" id="pauseMenuBtn">â˜° ĞœĞ•ĞĞ®</button>
  </div>
</div>

<!-- â•â•â• HUD â•â•â• -->
<div id="ui">
  <div class="stats-row">
    <div class="stat-pill"><div class="stat-lbl">ĞÑ‡ĞºĞ¸</div><div class="stat-val" id="scoreVal">0</div></div>
    <div class="stat-pill"><div class="stat-lbl">â¤ï¸ Ğ–Ğ¸Ğ·Ğ½Ğ¸</div><div class="stat-val lives" id="livesVal">3</div></div>
    <div class="stat-pill"><div class="stat-lbl">Ğ£Ñ€Ğ¾Ğ²ĞµĞ½ÑŒ</div><div class="stat-val level-val" id="levelVal">1</div></div>
  </div>
  <div id="levelBar"><div id="levelFill" style="width:0%"></div></div>
  <div id="xpRow">
    <div class="xp-lbl">ğŸš€ UR.</div>
    <div class="xp-track"><div class="xp-fill-bar" id="xpFill" style="width:0%"></div></div>
    <div class="xp-lvl">Ğ£Ñ€.<span id="shipLvlVal">1</span></div>
  </div>
</div>

<!-- Pause button -->
<button id="pauseBtn" aria-label="ĞŸĞ°ÑƒĞ·Ğ°">
  <svg viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
</button>

<!-- Combo -->
<div id="comboDisplay" class="combo-hidden">
  <div class="combo-word">COMBO</div>
  <div class="combo-num" id="comboVal">x2</div>
</div>

<div id="notifications"></div>
<div id="powerupBar"></div>

<!-- Boss bar -->
<div id="bossBar">
  <div class="boss-lbl">ğŸ‘¾ <span id="bossName">BOSS</span></div>
  <div class="boss-track"><div id="bossFill" style="width:100%"></div></div>
</div>

<!-- Bottom bar: weapons + auto -->
<div id="bottomBar">
  <div class="weapons-group">
    <div class="weapon-btn active" data-weapon="laser"><div class="weapon-emoji">ğŸ”µ</div><div class="weapon-lbl">LASER</div></div>
    <div class="weapon-btn" data-weapon="rocket"><div class="weapon-emoji">ğŸš€</div><div class="weapon-lbl">ROCKET</div></div>
    <div class="weapon-btn" data-weapon="shotgun"><div class="weapon-emoji">ğŸ’¥</div><div class="weapon-lbl">SHOT</div></div>
  </div>
  <button id="autoBtn" class="active">âš¡ ĞĞ’Ğ¢Ğ</button>
</div>

<!-- Achievement toast -->
<div id="achieveToast">
  <div class="ach-lbl">ğŸ† Ğ”ĞĞ¡Ğ¢Ğ˜Ğ–Ğ•ĞĞ˜Ğ•</div>
  <div class="ach-name" id="achieveName"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SCREENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- DIFFICULTY / MAIN MENU -->
<div id="difficultyScreen" class="screen active">
  <div class="card">
    <h1 class="screen-title green">ğŸš€ SPACE<br>SHOOTER</h1>
    <p class="screen-sub">Ğ’Ğ«Ğ‘Ğ•Ğ Ğ˜Ğ¢Ğ• Ğ¡Ğ›ĞĞ–ĞĞĞ¡Ğ¢Ğ¬</p>
    <div class="diff-item" data-diff="easy"><div class="diff-icon">ğŸ˜Š</div><div><div class="diff-name">Ğ›Ğ•Ğ“ĞšĞ</div><div class="diff-desc">5 Ğ¶Ğ¸Ğ·Ğ½ĞµĞ¹ â€¢ ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğµ Ğ²Ñ€Ğ°Ğ³Ğ¸ â€¢ Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ²</div></div></div>
    <div class="diff-item" data-diff="normal"><div class="diff-icon">ğŸ˜</div><div><div class="diff-name">ĞĞĞ ĞœĞĞ›Ğ¬ĞĞ</div><div class="diff-desc">3 Ğ¶Ğ¸Ğ·Ğ½Ğ¸ â€¢ Ğ¡Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ¸Ğ³Ñ€Ğ°</div></div></div>
    <div class="diff-item" data-diff="hard"><div class="diff-icon">ğŸ˜¤</div><div><div class="diff-name">Ğ¡Ğ›ĞĞ–ĞĞ</div><div class="diff-desc">2 Ğ¶Ğ¸Ğ·Ğ½Ğ¸ â€¢ Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ğ²Ñ€Ğ°Ğ³Ğ¸ â€¢ Ğ¡Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ±Ğ¾ÑÑÑ‹</div></div></div>
    <div class="diff-item" data-diff="nightmare"><div class="diff-icon">ğŸ’€</div><div><div class="diff-name">ĞšĞĞ¨ĞœĞĞ  <span class="diff-badge nm">Ğ¥ĞĞ Ğ”ĞšĞĞ </span></div><div class="diff-desc">1 Ğ¶Ğ¸Ğ·Ğ½ÑŒ â€¢ Ğ‘ĞµĞ· Ğ±Ğ¾Ğ½ÑƒÑĞ¾Ğ² â€¢ Ğ­ĞºÑÑ‚Ñ€ĞµĞ¼Ğ°Ğ»ÑŒĞ½Ğ¾</div></div></div>
    <div class="check-row">
      <input type="checkbox" id="autoChk" checked>
      <label for="autoChk">âš¡ ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑÑ‚Ñ€ĞµĞ»ÑŒĞ±Ğ°</label>
    </div>
    <button class="btn btn-primary" id="startBtn" disabled>â–¶ ĞĞĞ§ĞĞ¢Ğ¬ Ğ˜Ğ“Ğ Ğ£</button>
    <div class="menu-grid mt2">
      <button class="btn btn-secondary" id="customBtn">ğŸ¨ Ğ¡Ğ¢Ğ˜Ğ›Ğ¬</button>
      <button class="btn btn-secondary btn-gold" id="upgradeBtn">âš¡ ĞŸĞ ĞĞšĞĞ§ĞšĞ</button>
      <button class="btn btn-secondary btn-cyan" id="lbBtn">ğŸ† Ğ Ğ•Ğ™Ğ¢Ğ˜ĞĞ“</button>
      <button class="btn btn-secondary btn-purple" id="skinBtn">ğŸ‘¾ Ğ¡ĞšĞ˜ĞĞ«</button>
    </div>
  </div>
</div>

<!-- GAME OVER -->
<div id="gameOverScreen" class="screen">
  <div class="card">
    <h1 class="screen-title green" style="font-size:34px;margin-bottom:4px">GAME OVER</h1>
    <p class="screen-sub">Ğ Ğ•Ğ—Ğ£Ğ›Ğ¬Ğ¢ĞĞ¢</p>
    <div class="score-block"><div class="score-lbl">Ğ’ĞĞ¨ Ğ¡Ğ§ĞĞ¢</div><div class="score-val" id="goScore">0</div></div>
    <div class="flex gap2">
      <div class="score-block grow"><div class="score-lbl">Ğ£Ğ ĞĞ’Ğ•ĞĞ¬</div><div class="score-val" id="goLevel" style="font-size:20px">1</div></div>
      <div class="score-block grow"><div class="score-lbl">ĞœĞĞšĞ¡ ĞšĞĞœĞ‘Ğ</div><div class="score-val" id="goCombo" style="font-size:20px">x1</div></div>
    </div>
    <div class="score-block"><div class="score-lbl">ğŸ† Ğ Ğ•ĞšĞĞ Ğ”</div><div class="score-val record" id="goBest">0</div></div>
    <div class="coins-earned" id="goCoins">ğŸ’° ĞœĞ¾Ğ½ĞµÑ‚: 0</div>
    <div class="ach-badges" id="goAch"></div>
    <div class="flex gap2 mt2">
      <button class="btn btn-primary grow" id="restartBtn">â†º Ğ¡ĞĞĞ’Ğ</button>
      <button class="btn btn-secondary grow" id="menuBtn">â˜° ĞœĞ•ĞĞ®</button>
    </div>
  </div>
</div>

<!-- UPGRADE -->
<div id="upgradeScreen" class="screen">
  <div class="card">
    <h1 class="screen-title gold">âš¡ ĞŸĞ ĞĞšĞĞ§ĞšĞ</h1>
    <p class="screen-sub">Ğ£Ğ›Ğ£Ğ§Ğ¨Ğ˜ ĞšĞĞ ĞĞ‘Ğ›Ğ¬</p>
    <div class="coins-banner">ğŸ’° ĞœĞ¾Ğ½ĞµÑ‚Ñ‹: <span id="coinsVal">0</span></div>
    <div id="upgList"></div>
    <button class="btn btn-secondary btn-gold w100 mt2" id="backFromUpgrade">â† ĞĞĞ—ĞĞ”</button>
  </div>
</div>

<!-- LEADERBOARD -->
<div id="lbScreen" class="screen">
  <div class="card">
    <h1 class="screen-title cyan">ğŸ† Ğ Ğ•Ğ™Ğ¢Ğ˜ĞĞ“</h1>
    <p class="screen-sub">ĞœĞ˜Ğ ĞĞ’Ğ«Ğ• Ğ Ğ•ĞšĞĞ Ğ”Ğ«</p>
    <div id="lbContent"><div class="lb-loading">â³ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ...</div></div>
    <button class="btn btn-secondary btn-cyan w100 mt2" id="backFromLb">â† ĞĞĞ—ĞĞ”</button>
  </div>
</div>

<!-- CUSTOMIZE -->
<div id="customScreen" class="screen">
  <div class="card">
    <h1 class="screen-title green" style="font-size:22px">ğŸ¨ ĞšĞĞ¡Ğ¢ĞĞœĞ˜Ğ—ĞĞ¦Ğ˜Ğ¯</h1>
    <p class="screen-sub">ĞĞĞ¡Ğ¢Ğ ĞĞ™ ĞšĞĞ ĞĞ‘Ğ›Ğ¬</p>

    <div class="cust-section">
      <div class="cust-lbl">ğŸš€ Ğ¤Ğ¾Ñ€Ğ¼Ğ° ĞºĞ¾Ñ€Ğ°Ğ±Ğ»Ñ</div>
      <div class="shape-grid">
        <div class="shape-opt sel" data-ship-shape="fighter"><div class="shape-name">âš”ï¸ Ğ‘ĞĞ•Ğ¦</div><div class="shape-desc">ĞšĞ»Ğ°ÑÑĞ¸ĞºĞ°</div></div>
        <div class="shape-opt" data-ship-shape="arrow"><div class="shape-name">ğŸ¹ Ğ¡Ğ¢Ğ Ğ•Ğ›Ğ</div><div class="shape-desc">ĞÑÑ‚Ñ€Ñ‹Ğ¹</div></div>
        <div class="shape-opt" data-ship-shape="diamond"><div class="shape-name">ğŸ’ ĞšĞ Ğ˜Ğ¡Ğ¢ĞĞ›Ğ›</div><div class="shape-desc">Ğ¨Ğ¸Ñ€Ğ¾ĞºĞ¸Ğ¹</div></div>
      </div>
    </div>

    <div class="cust-section">
      <div class="cust-lbl">ğŸ¨ Ğ¦Ğ²ĞµÑ‚ ĞºĞ¾Ñ€Ğ°Ğ±Ğ»Ñ</div>
      <div class="color-grid">
        <div class="color-opt" data-ship-color="green" style="background:linear-gradient(135deg,#00ff88,#00d4ff)"><i>âœ“</i></div>
        <div class="color-opt" data-ship-color="blue" style="background:linear-gradient(135deg,#00d4ff,#0080ff)"><i>âœ“</i></div>
        <div class="color-opt" data-ship-color="purple" style="background:linear-gradient(135deg,#a855f7,#ec4899)"><i>âœ“</i></div>
        <div class="color-opt" data-ship-color="orange" style="background:linear-gradient(135deg,#ff6b00,#ff9900)"><i>âœ“</i></div>
        <div class="color-opt" data-ship-color="red" style="background:linear-gradient(135deg,#ff0066,#ff3366)"><i>âœ“</i></div>
        <div class="color-opt" data-ship-color="yellow" style="background:linear-gradient(135deg,#ffd700,#ffed4e)"><i>âœ“</i></div>
      </div>
    </div>

    <div class="cust-section">
      <div class="cust-lbl">ğŸ”µ Ğ¦Ğ²ĞµÑ‚ Ğ¿ÑƒĞ»ÑŒ</div>
      <div class="color-grid">
        <div class="color-opt" data-bullet-color="yellow" style="background:linear-gradient(135deg,#ffff00,#ff9900)"><i>âœ“</i></div>
        <div class="color-opt" data-bullet-color="cyan" style="background:linear-gradient(135deg,#00ffff,#00d4ff)"><i>âœ“</i></div>
        <div class="color-opt" data-bullet-color="pink" style="background:linear-gradient(135deg,#ff69b4,#ff1493)"><i>âœ“</i></div>
        <div class="color-opt" data-bullet-color="green" style="background:linear-gradient(135deg,#00ff88,#00ff00)"><i>âœ“</i></div>
        <div class="color-opt" data-bullet-color="white" style="background:linear-gradient(135deg,#ffffff,#cccccc)"><i>âœ“</i></div>
        <div class="color-opt" data-bullet-color="purple" style="background:linear-gradient(135deg,#a855f7,#8b5cf6)"><i>âœ“</i></div>
      </div>
    </div>

    <div class="cust-section">
      <div class="cust-lbl">âš¡ Ğ¡Ñ‚Ğ¸Ğ»ÑŒ ÑÑ‚Ñ€ĞµĞ»ÑŒĞ±Ñ‹</div>
      <div class="style-grid">
        <div class="style-opt sel" data-shoot-style="single"><div class="style-name">ĞĞ”Ğ˜ĞĞĞ§ĞĞĞ¯</div><div class="style-desc">1 Ğ¿ÑƒĞ»Ñ</div></div>
        <div class="style-opt" data-shoot-style="double"><div class="style-name">Ğ”Ğ’ĞĞ™ĞĞĞ¯</div><div class="style-desc">2 Ğ¿ÑƒĞ»Ğ¸</div></div>
        <div class="style-opt" data-shoot-style="triple"><div class="style-name">Ğ¢Ğ ĞĞ™ĞĞĞ¯</div><div class="style-desc">3 Ğ¿ÑƒĞ»Ğ¸</div></div>
      </div>
    </div>

    <div class="cust-section">
      <div class="toggle-row"><input type="checkbox" id="particlesChk" checked><label for="particlesChk">âœ¨ Ğ­Ñ„Ñ„ĞµĞºÑ‚Ñ‹ Ñ‡Ğ°ÑÑ‚Ğ¸Ñ†</label></div>
      <div class="toggle-row"><input type="checkbox" id="glowChk" checked><label for="glowChk">ğŸ’¡ Ğ­Ñ„Ñ„ĞµĞºÑ‚Ñ‹ ÑĞ²ĞµÑ‡ĞµĞ½Ğ¸Ñ</label></div>
    </div>

    <div class="flex gap2 mt1">
      <button class="btn btn-primary grow" id="saveCustomBtn">âœ“ Ğ¡ĞĞ¥Ğ ĞĞĞ˜Ğ¢Ğ¬</button>
      <button class="btn btn-secondary grow" id="backFromCustom">â† ĞĞĞ—ĞĞ”</button>
    </div>
  </div>
</div>

<!-- SKIN SCREEN -->
<div id="skinScreen" class="screen">
  <div class="card">
    <h1 class="screen-title purple">ğŸ‘¾ Ğ¡ĞšĞ˜ĞĞ«</h1>
    <p class="screen-sub">ĞĞ‘Ğ›Ğ˜Ğš ĞšĞĞ ĞĞ‘Ğ›Ğ¯</p>
    <div class="skin-grid" id="skinGrid"></div>
    <button class="btn btn-secondary btn-purple w100" id="backFromSkin">â† ĞĞĞ—ĞĞ”</button>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TELEGRAM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const tg = window.Telegram?.WebApp;
if(tg){ tg.expand(); tg.enableClosingConfirmation(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CANVAS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUDIO (Web Audio API â€” Ğ±ĞµĞ· Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const AC = window.AudioContext || window.webkitAudioContext;
let audioCtx = null;
function getAC(){ if(!audioCtx) audioCtx = new AC(); return audioCtx; }

function playSound(type){
  try{
    const ac = getAC();
    const g = ac.createGain();
    g.connect(ac.destination);
    const o = ac.createOscillator();
    o.connect(g);
    if(type==='shoot'){
      o.type='square'; o.frequency.setValueAtTime(880,ac.currentTime); o.frequency.exponentialRampToValueAtTime(220,ac.currentTime+.08);
      g.gain.setValueAtTime(.06,ac.currentTime); g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+.1);
      o.start(); o.stop(ac.currentTime+.1);
    }else if(type==='explode'){
      const buf = ac.createBuffer(1,ac.sampleRate*.15,ac.sampleRate);
      const d = buf.getChannelData(0);
      for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/d.length*8);
      const src = ac.createBufferSource(); src.buffer=buf; src.connect(g);
      g.gain.setValueAtTime(.18,ac.currentTime); g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+.15);
      src.start(); return;
    }else if(type==='hit'){
      o.type='sawtooth'; o.frequency.setValueAtTime(220,ac.currentTime); o.frequency.exponentialRampToValueAtTime(80,ac.currentTime+.08);
      g.gain.setValueAtTime(.1,ac.currentTime); g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+.1);
      o.start(); o.stop(ac.currentTime+.1);
    }else if(type==='powerup'){
      o.type='sine'; o.frequency.setValueAtTime(440,ac.currentTime); o.frequency.exponentialRampToValueAtTime(880,ac.currentTime+.12);
      g.gain.setValueAtTime(.12,ac.currentTime); g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+.15);
      o.start(); o.stop(ac.currentTime+.15);
    }else if(type==='boss'){
      o.type='sawtooth'; o.frequency.setValueAtTime(110,ac.currentTime); o.frequency.exponentialRampToValueAtTime(55,ac.currentTime+.3);
      g.gain.setValueAtTime(.2,ac.currentTime); g.gain.exponentialRampToValueAtTime(.001,ac.currentTime+.35);
      o.start(); o.stop(ac.currentTime+.35);
    }else if(type==='levelup'){
      const freqs=[523,659,784,1047];
      freqs.forEach((f,i)=>{
        const oo=ac.createOscillator(), gg=ac.createGain();
        oo.connect(gg); gg.connect(ac.destination);
        oo.type='sine'; oo.frequency.value=f;
        gg.gain.setValueAtTime(0,ac.currentTime+i*.08);
        gg.gain.linearRampToValueAtTime(.12,ac.currentTime+i*.08+.04);
        gg.gain.exponentialRampToValueAtTime(.001,ac.currentTime+i*.08+.15);
        oo.start(ac.currentTime+i*.08); oo.stop(ac.currentTime+i*.08+.15);
      });
      return;
    }
  }catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERSISTENT DATA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const LS = {
  get:(k,def='')=>{ try{ const v=localStorage.getItem(k); return v===null?def:v; }catch(e){return def;} },
  set:(k,v)=>{ try{ localStorage.setItem(k,String(v)); }catch(e){} },
  getJ:(k,def)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch(e){return def;} },
  setJ:(k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)); }catch(e){} }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPGRADES SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const UPGRADES = {
  damage:   {max:5, base:100, mult:1.6, label:'Ğ£Ñ€Ğ¾Ğ½',          desc:'Ğ‘Ğ¾Ğ»ÑŒÑˆĞµ ÑƒÑ€Ğ¾Ğ½Ğ° Ğ¿Ğ¾ Ğ²Ñ€Ğ°Ğ³Ğ°Ğ¼',    icon:'ğŸ”«'},
  speed:    {max:5, base:80,  mult:1.5, label:'Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ğ¿ÑƒĞ»ÑŒ', desc:'ĞŸÑƒĞ»Ğ¸ Ğ»ĞµÑ‚ÑÑ‚ Ğ±Ñ‹ÑÑ‚Ñ€ĞµĞµ',         icon:'ğŸ’¨'},
  firerate: {max:5, base:120, mult:1.7, label:'Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚Ñ€ĞµĞ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ', desc:'Ğ‘Ñ‹ÑÑ‚Ñ€ĞµĞµ ÑÑ‚Ñ€ĞµĞ»ÑŒĞ±Ğ°',        icon:'âš¡'},
  shield:   {max:3, base:200, mult:2.0, label:'Ğ¡Ñ‚Ğ°Ñ€Ñ‚Ğ¾Ğ²Ñ‹Ğ¹ Ñ‰Ğ¸Ñ‚', desc:'ĞĞ°Ñ‡Ğ¸Ğ½Ğ°Ñ‚ÑŒ Ğ¸Ğ³Ñ€Ñƒ ÑĞ¾ Ñ‰Ğ¸Ñ‚Ğ¾Ğ¼',    icon:'ğŸ›¡ï¸'},
  magnet:   {max:3, base:150, mult:1.8, label:'ĞœĞ°Ğ³Ğ½Ğ¸Ñ‚',        desc:'Ğ‘Ğ¾Ğ½ÑƒÑÑ‹ Ğ»ĞµÑ‚ÑÑ‚ Ğº Ğ²Ğ°Ğ¼',         icon:'ğŸ§²'}
};

let upgrades = LS.getJ('upgrades', {damage:0,speed:0,firerate:0,shield:0,magnet:0});
let coins    = +LS.get('coins', 0);
let shipXP   = +LS.get('shipXP', 0);
let shipLvl  = +LS.get('shipLvl', 1);

function savePersistent(){
  LS.setJ('upgrades', upgrades);
  LS.set('coins', coins);
  LS.set('shipXP', shipXP);
  LS.set('shipLvl', shipLvl);
}

function upgCost(k){ return Math.floor(UPGRADES[k].base * Math.pow(UPGRADES[k].mult, upgrades[k])); }

let cachedBonus = null;
function getBonus(){
  if(!cachedBonus) cachedBonus = {
    bulletSpeedMult: 1 + upgrades.speed    * 0.15,
    damageMult:      1 + upgrades.damage   * 0.25,
    firerateMult:    1 - upgrades.firerate * 0.08,
    hasStartShield:  upgrades.shield > 0,
    magnetRadius:    upgrades.magnet * 60
  };
  return cachedBonus;
}
function invalidateBonus(){ cachedBonus = null; }

function addShipXP(amt){
  shipXP += amt;
  const needed = shipLvl * 500;
  if(shipXP >= needed){
    shipXP -= needed; shipLvl++;
    coins += 100;
    savePersistent();
    notify('â­ ĞšĞĞ ĞĞ‘Ğ›Ğ¬ Ğ£Ğ .'+shipLvl+'! +100ğŸ’°', 'gold');
  }
  savePersistent();
  renderXPBar();
}

function renderXPBar(){
  const pct = Math.min(100, shipXP / (shipLvl * 500) * 100);
  document.getElementById('xpFill').style.width = pct + '%';
  document.getElementById('shipLvlVal').textContent = shipLvl;
}
renderXPBar();

function renderUpgradeScreen(){
  document.getElementById('coinsVal').textContent = coins;
  const list = document.getElementById('upgList');
  list.innerHTML = '';
  Object.keys(UPGRADES).forEach(k => {
    const u = UPGRADES[k], lvl = upgrades[k], maxed = lvl >= u.max, cost = upgCost(k);
    const div = document.createElement('div');
    div.className = 'upg-item' + (maxed?' maxed':'');
    const stars = Array.from({length:u.max},(_,i)=>`<div class="star${i<lvl?' on':''}"></div>`).join('');
    div.innerHTML = `
      <div class="upg-icon">${u.icon}</div>
      <div class="grow">
        <div class="upg-name">${u.label}</div>
        <div class="upg-desc">${u.desc}</div>
        <div class="upg-stars">${stars}</div>
      </div>
      <button class="upg-btn${maxed?' maxed':''}" data-upg="${k}" ${(maxed||coins<cost)?'disabled':''}>
        ${maxed ? 'âœ… ĞœĞĞšĞ¡' : `â¬†ï¸ ${cost}ğŸ’°`}
      </button>`;
    list.appendChild(div);
  });
  list.querySelectorAll('[data-upg]').forEach(btn => {
    btn.addEventListener('click', ()=>{
      const k = btn.dataset.upg;
      const cost = upgCost(k);
      if(coins < cost || upgrades[k] >= UPGRADES[k].max) return;
      coins -= cost; upgrades[k]++;
      invalidateBonus();
      savePersistent();
      renderUpgradeScreen();
      renderXPBar();
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// LEADERBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let bestScore = +LS.get('bestScore', 0);

async function loadLeaderboard(){
  const content = document.getElementById('lbContent');
  content.innerHTML = '<div class="lb-loading">â³ Ğ—ĞĞ“Ğ Ğ£Ğ—ĞšĞ...</div>';
  const myName = tg?.initDataUnsafe?.user?.first_name || 'Ğ˜Ğ³Ñ€Ğ¾Ğº';
  const myId   = tg?.initDataUnsafe?.user?.id || 0;
  let entries = LS.getJ('leaderboard', []);
  if(bestScore > 0){
    entries = entries.filter(e => e.id !== myId);
    entries.push({id:myId, name:myName, score:bestScore, lvl:shipLvl});
    entries.sort((a,b)=>b.score-a.score);
    entries = entries.slice(0,20);
    LS.setJ('leaderboard', entries);
  }
  const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  content.innerHTML = entries.length
    ? entries.map((e,i)=>`
      <div class="lb-row ${e.id===myId?'me':''}">
        <div class="lb-rank">${medals[i]||'#'+(i+1)}</div>
        <div class="lb-info">
          <div class="lb-name">${e.name}${e.id===myId?' ğŸ‘ˆ':''}</div>
          <div class="lb-sub">ĞšĞ¾Ñ€Ğ°Ğ±Ğ»ÑŒ ÑƒÑ€.${e.lvl||1}</div>
        </div>
        <div class="lb-score">${e.score.toLocaleString()}</div>
      </div>`).join('')
    : '<div class="lb-loading">ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ·Ğ°Ğ¿Ğ¸ÑĞµĞ¹. Ğ¡Ñ‹Ğ³Ñ€Ğ°Ğ¹Ñ‚Ğµ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¼! ğŸš€</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SKINS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let unlockedAch = LS.getJ('achievements', []);
const ACHIEVEMENTS = [
  {id:'first_kill', name:'ĞŸĞµÑ€Ğ²Ğ°Ñ ĞºÑ€Ğ¾Ğ²ÑŒ ğŸ”«'},
  {id:'combo5',     name:'ĞšĞ¾Ğ¼Ğ±Ğ¾ Ğ¼Ğ°ÑÑ‚ĞµÑ€ âš¡'},
  {id:'combo10',    name:'Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ° ĞºĞ¾Ğ¼Ğ±Ğ¾ ğŸŒŸ'},
  {id:'boss1',      name:'Ğ£Ğ±Ğ¸Ğ¹Ñ†Ğ° Ğ±Ğ¾ÑÑĞ¾Ğ² ğŸ’€'},
  {id:'score1000',  name:'Ğ¢Ñ‹ÑÑÑ‡Ğ½Ğ¸Ğº ğŸ¯'},
  {id:'score5000',  name:'ĞŸÑÑ‚ÑŒ Ñ‚Ñ‹ÑÑÑ‡ ğŸ†'},
  {id:'shield',     name:'ĞĞµÑƒÑĞ·Ğ²Ğ¸Ğ¼Ñ‹Ğ¹ ğŸ›¡ï¸'},
  {id:'survive5',   name:'Ğ’Ñ‹Ğ¶Ğ¸Ğ²ÑˆĞ¸Ğ¹ ğŸ’ª'},
];

const SKINS = [
  {id:'default', name:'Ğ¡Ğ¢ĞĞĞ”ĞĞ Ğ¢',  emoji:'ğŸš€', req:'ĞĞ°Ñ‡Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹',     cond:()=>true},
  {id:'fire',    name:'ĞĞ“ĞĞ•ĞĞĞ«Ğ™',  emoji:'ğŸ”¥', req:'50 ÑƒĞ±Ğ¸Ğ¹ÑÑ‚Ğ²',    cond:()=>+LS.get('totalKills',0)>=50},
  {id:'ice',     name:'Ğ›Ğ•Ğ”Ğ¯ĞĞĞ™',   emoji:'â„ï¸', req:'ĞšĞ¾Ñ€Ğ°Ğ±Ğ»ÑŒ ÑƒÑ€.10', cond:()=>shipLvl>=10},
  {id:'ghost',   name:'ĞŸĞ Ğ˜Ğ—Ğ ĞĞš',   emoji:'ğŸ‘»', req:'3 Ğ±Ğ¾ÑÑĞ°',       cond:()=>+LS.get('totalBosses',0)>=3},
  {id:'gold',    name:'Ğ—ĞĞ›ĞĞ¢ĞĞ™',   emoji:'â­', req:'1000+ Ğ¼Ğ¾Ğ½ĞµÑ‚',   cond:()=>coins>=1000},
  {id:'dragon',  name:'Ğ”Ğ ĞĞšĞĞ',    emoji:'ğŸ‰', req:'ĞšĞ¾Ğ¼Ğ±Ğ¾ x15',     cond:()=>+LS.get('maxComboEver',0)>=15},
  {id:'alien',   name:'ĞŸĞ Ğ˜Ğ¨Ğ•Ğ›Ğ•Ğ¦',  emoji:'ğŸ‘¾', req:'5 Ğ±Ğ¾ÑÑĞ¾Ğ²',      cond:()=>+LS.get('totalBosses',0)>=5},
  {id:'rainbow', name:'Ğ ĞĞ”Ğ£Ğ“Ğ',    emoji:'ğŸŒˆ', req:'Ğ’ÑĞµ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ñ', cond:()=>unlockedAch.length>=ACHIEVEMENTS.length},
];
const SKIN_COLORS = {
  default:{a:'#00ff88',b:'#00d4ff',trail:'#00ff8866',glow:'#00ff88'},
  fire:   {a:'#ff6b00',b:'#ff0000',trail:'#ff6b0066',glow:'#ff6b00'},
  ice:    {a:'#00d4ff',b:'#a0f0ff',trail:'#00d4ff66',glow:'#00d4ff'},
  ghost:  {a:'#ccccff',b:'#8888ff',trail:'#ccccff44',glow:'#ccccff'},
  gold:   {a:'#ffd700',b:'#ff9900',trail:'#ffd70066',glow:'#ffd700'},
  dragon: {a:'#a855f7',b:'#ec4899',trail:'#a855f766',glow:'#a855f7'},
  alien:  {a:'#00ff00',b:'#44ff44',trail:'#00ff0066',glow:'#00ff00'},
  rainbow:{a:'#ff0088',b:'#00ffff',trail:'#ff008866',glow:'#ff88ff'},
};
let activeSkin = LS.get('activeSkin','default');

function renderSkinScreen(){
  const grid = document.getElementById('skinGrid');
  grid.innerHTML = '';
  SKINS.forEach(skin => {
    const ok = skin.cond(), isActive = activeSkin === skin.id;
    const div = document.createElement('div');
    div.className = `skin-item ${ok?'ok':''} ${isActive?'active':''} ${!ok?'locked':''}`;
    div.innerHTML = `
      ${isActive ? '<div class="skin-active-badge">âœ“ ĞĞšĞ¢Ğ˜Ğ’Ğ•Ğ</div>' : ''}
      <div class="skin-icon">${skin.emoji}</div>
      <div class="skin-name">${skin.name}</div>
      <div class="${ok?'skin-unlocked':'skin-req'}">${ok?'âœ… Ğ Ğ°Ğ·Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½':skin.req}</div>`;
    if(ok) div.addEventListener('click',()=>{ activeSkin=skin.id; LS.set('activeSkin',activeSkin); renderSkinScreen(); });
    grid.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CUSTOMIZATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SHIP_COLORS = {
  green:{a:'#00ff88',b:'#00d4ff'}, blue:{a:'#00d4ff',b:'#0080ff'}, purple:{a:'#a855f7',b:'#ec4899'},
  orange:{a:'#ff6b00',b:'#ff9900'}, red:{a:'#ff0066',b:'#ff3366'}, yellow:{a:'#ffd700',b:'#ffed4e'}
};
const BULLET_COLORS = {
  yellow:{a:'#ffff00',b:'#ff9900'}, cyan:{a:'#00ffff',b:'#00d4ff'}, pink:{a:'#ff69b4',b:'#ff1493'},
  green:{a:'#00ff88',b:'#00ff00'}, white:{a:'#ffffff',b:'#cccccc'}, purple:{a:'#a855f7',b:'#8b5cf6'}
};

let custom = {
  shipShape:   LS.get('shipShape',  'fighter'),
  shipColor:   LS.get('shipColor',  'green'),
  bulletColor: LS.get('bulletColor','yellow'),
  shootStyle:  LS.get('shootStyle', 'single'),
  particles:   LS.get('particles',  'true') !== 'false',
  glow:        LS.get('glow',       'true') !== 'false',
};

function loadCustomUI(){
  document.querySelectorAll('[data-ship-shape]').forEach(e=>e.classList.toggle('sel',e.dataset.shipShape===custom.shipShape));
  document.querySelectorAll('[data-ship-color]').forEach(e=>e.classList.toggle('sel',e.dataset.shipColor===custom.shipColor));
  document.querySelectorAll('[data-bullet-color]').forEach(e=>e.classList.toggle('sel',e.dataset.bulletColor===custom.bulletColor));
  document.querySelectorAll('[data-shoot-style]').forEach(e=>e.classList.toggle('sel',e.dataset.shootStyle===custom.shootStyle));
  document.getElementById('particlesChk').checked = custom.particles;
  document.getElementById('glowChk').checked = custom.glow;
}
function saveCustom(){
  custom.particles = document.getElementById('particlesChk').checked;
  custom.glow      = document.getElementById('glowChk').checked;
  LS.set('shipShape',   custom.shipShape);
  LS.set('shipColor',   custom.shipColor);
  LS.set('bulletColor', custom.bulletColor);
  LS.set('shootStyle',  custom.shootStyle);
  LS.set('particles',   custom.particles);
  LS.set('glow',        custom.glow);
}

// Selection listeners for customize screen
[['data-ship-shape','shipShape'],['data-ship-color','shipColor'],['data-bullet-color','bulletColor'],['data-shoot-style','shootStyle']].forEach(([attr,key])=>{
  document.querySelectorAll(`[${attr}]`).forEach(el=>{
    el.addEventListener('click',function(){
      document.querySelectorAll(`[${attr}]`).forEach(e=>e.classList.remove('sel'));
      this.classList.add('sel');
      custom[key] = this.getAttribute(attr);
    });
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIFFICULTY CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DIFF = {
  easy:      {lives:5, spd:.7,  spawn:.013, scoreMult:1,   bossHpMult:.7,  powerupRate:.007},
  normal:    {lives:3, spd:1,   spawn:.018, scoreMult:1.5, bossHpMult:1,   powerupRate:.004},
  hard:      {lives:2, spd:1.5, spawn:.026, scoreMult:2,   bossHpMult:1.4, powerupRate:.002},
  nightmare: {lives:1, spd:2,   spawn:.034, scoreMult:3,   bossHpMult:2,   powerupRate:0}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SCREEN MANAGER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SCREENS = ['difficultyScreen','gameOverScreen','upgradeScreen','lbScreen','customScreen','skinScreen'];
function showScreen(id){ SCREENS.forEach(s=>{ const el=document.getElementById(s); if(el) el.style.display = s===id ? 'flex' : 'none'; }); }
function hideAllScreens(){ SCREENS.forEach(s=>{ const el=document.getElementById(s); if(el) el.style.display='none'; }); }
showScreen('difficultyScreen');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let difficulty = null;
let autoShoot  = LS.get('autoShoot','true') !== 'false';

document.querySelectorAll('[data-diff]').forEach(c=>{
  c.addEventListener('click',function(){
    document.querySelectorAll('[data-diff]').forEach(x=>x.classList.remove('selected'));
    this.classList.add('selected');
    difficulty = this.dataset.diff;
    document.getElementById('startBtn').disabled = false;
  });
});

document.getElementById('startBtn').addEventListener('click',()=>{ if(difficulty){ hideAllScreens(); startGame(); } });
document.getElementById('restartBtn').addEventListener('click',()=>{ hideAllScreens(); startGame(); });
document.getElementById('menuBtn').addEventListener('click',()=>{ showScreen('difficultyScreen'); });

document.getElementById('upgradeBtn').addEventListener('click',()=>{ renderUpgradeScreen(); showScreen('upgradeScreen'); });
document.getElementById('backFromUpgrade').addEventListener('click',()=>{ showScreen('difficultyScreen'); });

document.getElementById('lbBtn').addEventListener('click',()=>{ showScreen('lbScreen'); loadLeaderboard(); });
document.getElementById('backFromLb').addEventListener('click',()=>{ showScreen('difficultyScreen'); });

document.getElementById('customBtn').addEventListener('click',()=>{ loadCustomUI(); showScreen('customScreen'); });
document.getElementById('saveCustomBtn').addEventListener('click',()=>{ saveCustom(); showScreen('difficultyScreen'); });
document.getElementById('backFromCustom').addEventListener('click',()=>{ showScreen('difficultyScreen'); });

document.getElementById('skinBtn').addEventListener('click',()=>{ renderSkinScreen(); showScreen('skinScreen'); });
document.getElementById('backFromSkin').addEventListener('click',()=>{ showScreen('difficultyScreen'); });

// Auto shoot
function syncAutoUI(){
  document.getElementById('autoBtn').classList.toggle('active', autoShoot);
  document.getElementById('autoBtn').textContent = autoShoot ? 'âš¡ ĞĞ’Ğ¢Ğ' : 'âœ‹ Ğ Ğ£Ğ§Ğ.';
  document.getElementById('autoChk').checked = autoShoot;
}
syncAutoUI();
document.getElementById('autoBtn').addEventListener('click',()=>{ autoShoot=!autoShoot; LS.set('autoShoot',autoShoot); syncAutoUI(); });
document.getElementById('autoChk').addEventListener('change',function(){ autoShoot=this.checked; LS.set('autoShoot',autoShoot); syncAutoUI(); });

// Weapon selector
let currentWeapon = 'laser';
document.querySelectorAll('[data-weapon]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    currentWeapon = btn.dataset.weapon;
    document.querySelectorAll('[data-weapon]').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
  });
});

// Pause
let gamePaused = false;
document.getElementById('pauseBtn').addEventListener('click',()=>{
  if(!gameRunning) return;
  gamePaused = true;
  document.getElementById('pauseOverlay').style.display = 'flex';
});
document.getElementById('resumeBtn').addEventListener('click',()=>{
  gamePaused = false;
  document.getElementById('pauseOverlay').style.display = 'none';
  lastTime = performance.now();
  requestAnimationFrame(loop);
});
document.getElementById('pauseRestartBtn').addEventListener('click',()=>{
  gamePaused = false;
  document.getElementById('pauseOverlay').style.display = 'none';
  hideAllScreens(); startGame();
});
document.getElementById('pauseMenuBtn').addEventListener('click',()=>{
  gamePaused = false; gameRunning = false;
  document.getElementById('pauseOverlay').style.display = 'none';
  showScreen('difficultyScreen');
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BACKGROUND ELEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const stars=[], nebulas=[], planets=[], asteroids=[];

for(let i=0;i<130;i++) stars.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,s:Math.random()*2+.5,sp:Math.random()*1.8+.3,o:Math.random()*.55+.35});
for(let i=0;i<5;i++) nebulas.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:60+Math.random()*120,hue:Math.random()*360,o:.04+Math.random()*.06,sp:.15+Math.random()*.2});
for(let i=0;i<3;i++) planets.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:30+Math.random()*60,hue:Math.random()*360,sp:.05+Math.random()*.1,o:.12+Math.random()*.1,rings:Math.random()>.5,ringAngle:Math.random()*Math.PI});
for(let i=0;i<8;i++) asteroids.push({x:Math.random()*canvas.width,y:Math.random()*canvas.height,r:5+Math.random()*15,sp:.2+Math.random()*.6,angle:Math.random()*Math.PI*2,rot:(Math.random()-.5)*.02,pts:Array.from({length:7},(_,j)=>({a:j/7*Math.PI*2,r:.7+Math.random()*.6}))});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let gameRunning=false;
let score=0, lives=0, level=1, levelProgress=0;
let combo=1, maxCombo=1, comboTimer=0;
let bossActive=false, bossEnemy=null;
let killedEnemies=0, bossesKilled=0;
let sessionAch=[];
let activePowerups={shield:0, speed:0};
let shakeAmount=0, shakeX=0, shakeY=0;
let lastTime=0;

const player = {x:canvas.width/2, y:canvas.height-110, targetX:canvas.width/2, w:44, h:44};
const playerTrail = [];

// Object pools â€” pre-allocated for performance
const bullets=[], enemies=[], particles=[], powerups=[];
const MAX_PARTICLES = 300;

let lastShot = 0;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATION QUEUE (rate-limited to avoid DOM spam)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let notifQueue = [], notifBusy = false;
function notify(text, cls=''){
  notifQueue.push({text,cls});
  if(!notifBusy) flushNotif();
}
function flushNotif(){
  if(!notifQueue.length){ notifBusy=false; return; }
  notifBusy = true;
  const {text,cls} = notifQueue.shift();
  const container = document.getElementById('notifications');
  // Limit DOM children
  while(container.childElementCount > 4) container.removeChild(container.firstChild);
  const el = document.createElement('div');
  el.className = 'notif ' + cls;
  el.textContent = text;
  container.appendChild(el);
  setTimeout(()=>{ el.remove(); flushNotif(); }, 750);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ACHIEVEMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkAch(id){
  if(unlockedAch.includes(id) || sessionAch.includes(id)) return;
  const a = ACHIEVEMENTS.find(x=>x.id===id);
  if(!a) return;
  sessionAch.push(id); unlockedAch.push(id);
  LS.setJ('achievements', unlockedAch);
  const toast = document.getElementById('achieveToast');
  document.getElementById('achieveName').textContent = a.name;
  toast.style.display = 'block';
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>toast.style.display='none', 2500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHAKE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function triggerShake(s=8){ shakeAmount=s; }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EXPLOSION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function explode(x,y,color,count=28){
  if(!custom.particles) return;
  const cap = Math.min(count, MAX_PARTICLES - particles.length);
  for(let i=0;i<cap;i++) particles.push({x,y,vx:(Math.random()-.5)*11,vy:(Math.random()-.5)*11,life:1,decay:.014+Math.random()*.01,color,size:2+Math.random()*3,wave:false,bossShot:false});
  if(particles.length < MAX_PARTICLES)
    particles.push({x,y,vx:0,vy:0,life:1,decay:.04,color,wave:true,r:0,maxR:60+count,bossShot:false});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// POWERUPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnPowerup(x,y){
  const types=['shield','speed','bomb'];
  const type=types[Math.floor(Math.random()*types.length)];
  const icons={shield:'ğŸ›¡ï¸',speed:'âš¡',bomb:'ğŸ’£'};
  powerups.push({x,y,type,icon:icons[type],r:14,sp:.8,life:1,decay:.003,angle:0});
}
function applyPowerup(type){
  playSound('powerup');
  if(type==='shield'){
    activePowerups.shield=8000;
    notify('ğŸ›¡ï¸ Ğ©Ğ˜Ğ¢!');
    checkAch('shield');
  }else if(type==='speed'){
    activePowerups.speed=6000;
    notify('âš¡ Ğ£Ğ¡ĞšĞĞ Ğ•ĞĞ˜Ğ•!');
  }else if(type==='bomb'){
    const n=enemies.length;
    enemies.forEach(e=>explode(e.x,e.y,'#ff6b00',20));
    enemies.length=0;
    if(bossActive&&bossEnemy) bossEnemy.hp=Math.floor(bossEnemy.hp*.5);
    score+=n*20; updateHUD();
    notify('ğŸ’£ Ğ‘ĞĞœĞ‘Ğ! +'+n*20,'gold');
    triggerShake(14);
    playSound('explode');
  }
  updatePowerupBar();
}
function updatePowerupBar(){
  const bar=document.getElementById('powerupBar');
  bar.innerHTML='';
  if(activePowerups.shield>0){ const d=document.createElement('div'); d.className='pu-chip shield'; d.innerHTML='ğŸ›¡ï¸ '+Math.ceil(activePowerups.shield/1000)+'s'; bar.appendChild(d); }
  if(activePowerups.speed>0){  const d=document.createElement('div'); d.className='pu-chip speed';  d.innerHTML='âš¡ '+Math.ceil(activePowerups.speed/1000)+'s';  bar.appendChild(d); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WEAPONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const WEAPONS = {
  laser:   {baseCd:160, label:'Ğ›ĞĞ—Ğ•Ğ ',  color:'#00d4ff'},
  rocket:  {baseCd:600, label:'Ğ ĞĞšĞ•Ğ¢Ğ', color:'#ff6b00'},
  shotgun: {baseCd:800, label:'Ğ”Ğ ĞĞ‘Ğ¬',  color:'#ffd700'},
};

function shoot(){
  const bonus = getBonus();
  const now = Date.now();
  const wpn = WEAPONS[currentWeapon];
  const cd = (activePowerups.speed>0 ? wpn.baseCd*.6 : wpn.baseCd) * bonus.firerateMult;
  if(now - lastShot < cd) return;
  lastShot = now;
  playSound('shoot');

  const spd = 13 * bonus.bulletSpeedMult * (activePowerups.speed>0?1.3:1);
  const dmg = bonus.damageMult;
  const style = custom.shootStyle;

  if(currentWeapon==='laser'){
    const base={y:player.y,w:5,h:22,sp:spd,dmg,type:'laser'};
    if(style==='single') bullets.push({...base,x:player.x});
    else if(style==='double'){ bullets.push({...base,x:player.x-11}); bullets.push({...base,x:player.x+11}); }
    else { bullets.push({...base,x:player.x-16}); bullets.push({...base,x:player.x}); bullets.push({...base,x:player.x+16}); }
  }else if(currentWeapon==='rocket'){
    bullets.push({x:player.x,y:player.y,w:10,h:18,sp:7*bonus.bulletSpeedMult,dmg:dmg*3,type:'rocket',angle:0,homing:true});
  }else if(currentWeapon==='shotgun'){
    const s=10*bonus.bulletSpeedMult;
    for(let a=-3;a<=3;a++) bullets.push({x:player.x,y:player.y,w:6,h:14,sp:s,dmg,type:'shotgun',vx:a*1.8,pierce:true,pierced:new Set()});
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BOSS DEFINITIONS â€” 5 ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ±Ğ¾ÑÑĞ¾Ğ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BOSS_TYPES = [
  // 0 â€” Ğ¡Ğ¢Ğ ĞĞ– (ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ 5): ĞºĞ»Ğ°ÑÑĞ¸ĞºĞ°, 3 ÑĞ½Ğ°Ñ€ÑĞ´Ğ° Ğ²ĞµĞµÑ€Ğ¾Ğ¼
  {
    id:'guardian', name:'âš”ï¸ Ğ¡Ğ¢Ğ ĞĞ–', color:'#ff0066',
    hw:55, hh:45,
    init(b){ b.dir=1; b.shootTimer=0; b.phase=0; },
    update(b,dt){
      b.x+=b.sp*b.dir;
      if(b.x>canvas.width-b.hw||b.x<b.hw) b.dir*=-1;
      if(b.y<120) b.y+=1.8;
      b.shootTimer-=dt;
      if(b.shootTimer<=0){
        b.shootTimer = Math.max(700, 1600-level*70);
        // 3-ÑĞ½Ğ°Ñ€ÑĞ´Ğ½Ñ‹Ğ¹ Ğ²ĞµĞµÑ€
        for(let a=-1;a<=1;a++){
          spawnBossShot(b.x+a*20, b.y+b.hh, a*.7, 3+level*.05, '#ff0066', 8);
        }
      }
    },
    draw(b,ctx,animT){
      const col='#ff0066';
      const eg=ctx.createRadialGradient(0,0,0,0,0,b.hw);
      eg.addColorStop(0,col+'ff'); eg.addColorStop(.6,col+'aa'); eg.addColorStop(1,col+'22');
      ctx.fillStyle=eg; ctx.beginPath();
      ctx.moveTo(0,-b.hh); ctx.lineTo(-b.hw*.7,-b.hh*.3); ctx.lineTo(-b.hw,b.hh);
      ctx.lineTo(-b.hw*.3,b.hh*.4); ctx.lineTo(0,b.hh*.7);
      ctx.lineTo(b.hw*.3,b.hh*.4); ctx.lineTo(b.hw,b.hh); ctx.lineTo(b.hw*.7,-b.hh*.3);
      ctx.closePath(); ctx.fill();
      // Ğ“Ğ»Ğ°Ğ·Ğ°
      ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(-b.hw*.3,-b.hh*.1,4,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(b.hw*.3,-b.hh*.1,4,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#f00'; ctx.beginPath(); ctx.arc(-b.hw*.3,-b.hh*.1,2,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(b.hw*.3,-b.hh*.1,2,0,Math.PI*2); ctx.fill();
    }
  },

  // 1 â€” Ğ¡ĞĞĞ™ĞŸĞ•Ğ  (ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ 10): Ğ½Ğ°Ğ²Ğ¾Ğ´Ğ¸Ñ‚ÑÑ Ğ½Ğ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°, ÑÑ‚Ñ€ĞµĞ»ÑĞµÑ‚ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾
  {
    id:'sniper', name:'ğŸ¯ Ğ¡ĞĞĞ™ĞŸĞ•Ğ ', color:'#ff9900',
    hw:45, hh:55,
    init(b){ b.dir=1; b.shootTimer=0; b.chargeTimer=0; b.charging=false; b.aimX=0; b.aimY=0; },
    update(b,dt){
      // ĞœĞµĞ´Ğ»ĞµĞ½Ğ½Ğ¾ Ğ´Ñ€ĞµĞ¹Ñ„ÑƒĞµÑ‚ Ğ¿Ğ¾ Ğ³Ğ¾Ñ€Ğ¸Ğ·Ğ¾Ğ½Ñ‚Ğ°Ğ»Ğ¸
      b.x += Math.sin(Date.now()/1200)*1.2;
      b.x = Math.max(b.hw, Math.min(canvas.width-b.hw, b.x));
      if(b.y<100) b.y+=1.2;
      b.shootTimer-=dt;
      if(b.shootTimer<=0 && !b.charging){
        // ĞĞ°Ñ‡Ğ°Ñ‚ÑŒ Ğ·Ğ°Ñ€ÑĞ´ĞºÑƒ â€” Ğ¿Ñ€Ğ¸Ñ†ĞµĞ» Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ½Ğ° Ğ¸Ğ³Ñ€Ğ¾ĞºĞµ
        b.charging=true; b.chargeTimer=900;
        b.aimX=player.x; b.aimY=player.y;
      }
      if(b.charging){
        b.chargeTimer-=dt;
        if(b.chargeTimer<=0){
          b.charging=false;
          b.shootTimer = Math.max(1000, 2200-level*90);
          // ĞœĞ¾Ñ‰Ğ½Ñ‹Ğ¹ ÑĞ½Ğ°Ñ€ÑĞ´ Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ Ğ² Ğ·Ğ°Ñ„Ğ¸ĞºÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½ÑƒÑ Ğ¿Ğ¾Ğ·Ğ¸Ñ†Ğ¸Ñ
          const dx=b.aimX-b.x, dy=b.aimY-b.y, dist=Math.max(Math.hypot(dx,dy),1);
          const spd=7+level*.2;
          spawnBossShot(b.x, b.y+b.hh, dx/dist*spd, dy/dist*spd, '#ff9900', 12);
          spawnBossShot(b.x-10, b.y+b.hh, dx/dist*(spd*.9), dy/dist*(spd*.9)+'', '#ff9900', 7);
          spawnBossShot(b.x+10, b.y+b.hh, dx/dist*(spd*.9), dy/dist*(spd*.9), '#ff9900', 7);
        }
      }
    },
    draw(b,ctx,animT){
      const col='#ff9900';
      // Ğ¢Ğ¾Ğ½ĞºĞ¸Ğ¹ ÑƒĞ³Ğ»Ğ¾Ğ²Ğ°Ñ‚Ñ‹Ğ¹ ĞºĞ¾Ñ€Ğ¿ÑƒÑ
      ctx.fillStyle=ctx.createRadialGradient(0,0,0,0,0,b.hw);
      const eg=ctx.createRadialGradient(0,0,0,0,0,b.hw);
      eg.addColorStop(0,col+'ff'); eg.addColorStop(.5,col+'99'); eg.addColorStop(1,col+'11');
      ctx.fillStyle=eg;
      ctx.beginPath();
      ctx.moveTo(0,-b.hh); ctx.lineTo(-b.hw*.4,-b.hh*.2);
      ctx.lineTo(-b.hw,0); ctx.lineTo(-b.hw*.4,b.hh*.3);
      ctx.lineTo(0,b.hh); ctx.lineTo(b.hw*.4,b.hh*.3);
      ctx.lineTo(b.hw,0); ctx.lineTo(b.hw*.4,-b.hh*.2);
      ctx.closePath(); ctx.fill();
      // Ğ¦ĞµĞ½Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ³Ğ»Ğ°Ğ· / Ğ¿Ñ€Ğ¸Ñ†ĞµĞ»
      const eyeR = b.charging ? 10+5*Math.sin(animT*8) : 7;
      ctx.fillStyle = b.charging ? '#ffffff' : col+'99';
      ctx.beginPath(); ctx.arc(0,0,eyeR,0,Math.PI*2); ctx.fill();
      ctx.strokeStyle=col; ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(0,0,eyeR+4,0,Math.PI*2); ctx.stroke();
      // Ğ›Ğ°Ğ·ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ñ†ĞµĞ» Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ·Ğ°Ñ€ÑĞ´ĞºĞ¸
      if(b.charging){
        ctx.save(); ctx.globalAlpha=.5;
        ctx.strokeStyle='#ff9900'; ctx.lineWidth=1;
        ctx.setLineDash([4,6]);
        ctx.beginPath(); ctx.moveTo(0,b.hh); ctx.lineTo(b.aimX-b.x, b.aimY-b.y); ctx.stroke();
        ctx.setLineDash([]); ctx.restore();
      }
      // Ğ‘Ğ¾ĞºĞ¾Ğ²Ñ‹Ğµ Ğ¿ÑƒÑˆĞºĞ¸
      [-b.hw*.8,b.hw*.8].forEach(ox=>{
        ctx.fillStyle=col+'88';
        ctx.beginPath(); ctx.roundRect(ox-5,-6,10,20,3); ctx.fill();
      });
    }
  },

  // 2 â€” ĞĞ¡Ğ¬ĞœĞ˜ĞĞĞ“ (ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ 15): ÑĞ¿Ğ°Ğ²Ğ½Ğ¸Ñ‚ Ğ¼Ğ¸Ğ½Ğ¸Ğ²Ñ€Ğ°Ğ³Ğ¾Ğ², Ñ‰ÑƒĞ¿Ğ°Ğ»ÑŒÑ†Ğ°
  {
    id:'octopus', name:'ğŸ™ ĞĞ¡Ğ¬ĞœĞ˜ĞĞĞ“', color:'#a855f7',
    hw:60, hh:50,
    init(b){ b.spawnTimer=0; b.shootTimer=0; b.tentacleAngle=0; b.phase=0; },
    update(b,dt){
      // Ğ¡Ğ¸Ğ½ÑƒÑĞ¾Ğ¸Ğ´Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ
      b.x = canvas.width/2 + Math.sin(Date.now()/900)*(canvas.width*.35);
      if(b.y<110) b.y+=1.5;
      b.tentacleAngle += dt*.003;
      b.spawnTimer-=dt;
      if(b.spawnTimer<=0){
        b.spawnTimer = Math.max(1500, 4000-level*100);
        // Ğ¡Ğ¿Ğ°Ğ²Ğ½Ğ¸Ñ‚ Ğ¼Ğ°Ğ»ĞµĞ½ÑŒĞºĞ¾Ğ³Ğ¾ Ğ²Ñ€Ğ°Ğ³Ğ° Ñ€ÑĞ´Ğ¾Ğ¼ Ñ Ğ±Ğ¾ÑÑĞ¾Ğ¼
        if(enemies.filter(e=>!e.isBoss).length < 8){
          enemies.push({x:b.x+(Math.random()-.5)*80,y:b.y+20,hw:10,hh:10,sp:2,hp:1,maxHp:1,type:'fast',zigAngle:0,isBoss:false});
        }
      }
      b.shootTimer-=dt;
      if(b.shootTimer<=0){
        b.shootTimer = Math.max(500, 1200-level*50);
        // 8 ÑĞ½Ğ°Ñ€ÑĞ´Ğ¾Ğ² Ğ¿Ğ¾ ĞºÑ€ÑƒĞ³Ñƒ
        for(let i=0;i<8;i++){
          const ang = (i/8)*Math.PI*2 + b.tentacleAngle;
          spawnBossShot(b.x, b.y, Math.cos(ang)*2.5, Math.sin(ang)*2.5, '#a855f7', 7);
        }
      }
    },
    draw(b,ctx,animT){
      const col='#a855f7';
      // Ğ¢ĞµĞ»Ğ¾
      ctx.fillStyle=ctx.createRadialGradient(0,0,0,0,0,b.hw);
      const eg=ctx.createRadialGradient(0,0,0,0,0,b.hw);
      eg.addColorStop(0,col+'ff'); eg.addColorStop(.6,col+'bb'); eg.addColorStop(1,col+'11');
      ctx.fillStyle=eg;
      ctx.beginPath(); ctx.arc(0,0,b.hw*.7,0,Math.PI*2); ctx.fill();
      // Ğ©ÑƒĞ¿Ğ°Ğ»ÑŒÑ†Ğ°
      for(let i=0;i<8;i++){
        const ang = (i/8)*Math.PI*2 + b.tentacleAngle;
        const len = b.hw*.9 + 10*Math.sin(animT*3+i);
        ctx.save();
        ctx.strokeStyle=col+'99'; ctx.lineWidth=4;
        ctx.beginPath();
        ctx.moveTo(Math.cos(ang)*b.hw*.5, Math.sin(ang)*b.hw*.5);
        ctx.quadraticCurveTo(
          Math.cos(ang+.4)*len*.6, Math.sin(ang+.4)*len*.6,
          Math.cos(ang)*len, Math.sin(ang)*len
        );
        ctx.stroke(); ctx.restore();
      }
      // Ğ“Ğ»Ğ°Ğ·Ğ°
      ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(-12,-8,6,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(12,-8,6,0,Math.PI*2); ctx.fill();
      ctx.fillStyle='#6600ff'; ctx.beginPath(); ctx.arc(-12,-8,3,0,Math.PI*2); ctx.fill();
      ctx.beginPath(); ctx.arc(12,-8,3,0,Math.PI*2); ctx.fill();
    }
  },

  // 3 â€” Ğ”Ğ Ğ•Ğ”ĞĞĞ£Ğ¢ (ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ 20): Ğ¾Ğ³Ñ€Ğ¾Ğ¼Ğ½Ñ‹Ğ¹, Ğ¼ĞµĞ´Ğ»ĞµĞ½Ğ½Ñ‹Ğ¹, ÑÑ‚Ñ€ĞµĞ»ÑĞµÑ‚ Ğ»Ğ°Ğ·ĞµÑ€Ğ½Ñ‹Ğ¼Ğ¸ Ğ±Ğ°Ğ»ĞºĞ°Ğ¼Ğ¸
  {
    id:'dreadnought', name:'ğŸ›¸ Ğ”Ğ Ğ•Ğ”ĞĞĞ£Ğ¢', color:'#00d4ff',
    hw:75, hh:55,
    init(b){ b.dir=.5; b.shootTimer=0; b.laserChargeTimer=0; b.laserFiring=false; b.laserDuration=0; b.laserX=0; },
    update(b,dt){
      b.x+=b.sp*.5*b.dir;
      if(b.x>canvas.width-b.hw||b.x<b.hw) b.dir*=-1;
      if(b.y<90) b.y+=1;
      // Ğ›Ğ°Ğ·ĞµÑ€Ğ½Ğ°Ñ Ğ°Ñ‚Ğ°ĞºĞ°
      b.shootTimer-=dt;
      if(b.shootTimer<=0 && !b.laserFiring){
        b.shootTimer = Math.max(800, 3000-level*80);
        b.laserChargeTimer=600;
        b.laserX=player.x; // Ñ„Ğ¸ĞºÑĞ¸Ñ€ÑƒĞµĞ¼ X
      }
      if(b.laserChargeTimer>0){
        b.laserChargeTimer-=dt;
        if(b.laserChargeTimer<=0){
          b.laserFiring=true;
          b.laserDuration=400+level*15;
          triggerShake(8);
        }
      }
      if(b.laserFiring){
        b.laserDuration-=dt;
        // Ğ›Ğ°Ğ·ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ»ÑƒÑ‡ Ğ½Ğ°Ğ½Ğ¾ÑĞ¸Ñ‚ ÑƒÑ€Ğ¾Ğ½ Ğ¿Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ½Ğ¾
        if(Math.abs(player.x - b.laserX)<18){
          if(activePowerups.shield>0){ activePowerups.shield=0; notify('ğŸ›¡ï¸ Ğ©Ğ˜Ğ¢ Ğ¡Ğ›ĞĞœĞĞ'); updatePowerupBar(); }
          else { lives--; updateHUD(); if(lives<=0) endGame(); }
          b.laserX = player.x + (Math.random()-.5)*60; // Ğ½ĞµĞ±Ğ¾Ğ»ÑŒÑˆĞ¾Ğ¹ ÑĞ´Ğ²Ğ¸Ğ³ Ğ¿Ğ¾ÑĞ»Ğµ Ğ¿Ğ¾Ğ¿Ğ°Ğ´Ğ°Ğ½Ğ¸Ñ
        }
        if(b.laserDuration<=0) b.laserFiring=false;
        // Ğ ĞµĞ´ĞºĞ¸Ğµ Ğ±Ğ¾ĞºĞ¾Ğ²Ñ‹Ğµ ÑĞ½Ğ°Ñ€ÑĞ´Ñ‹
        if(Math.random()<.02) spawnBossShot(b.x+(Math.random()-.5)*b.hw*1.5, b.y+b.hh, (Math.random()-.5)*2, 2.5+level*.04, '#00d4ff', 8);
      }
    },
    draw(b,ctx,animT){
      const col='#00d4ff';
      // ĞšĞ¾Ñ€Ğ¿ÑƒÑ
      ctx.fillStyle='#001122';
      ctx.beginPath(); ctx.roundRect(-b.hw,-b.hh,b.hw*2,b.hh*2,10); ctx.fill();
      // ĞŸĞ°Ğ½ĞµĞ»Ğ¸
      const eg=ctx.createLinearGradient(-b.hw,-b.hh,b.hw,b.hh);
      eg.addColorStop(0,col+'66'); eg.addColorStop(.5,col+'33'); eg.addColorStop(1,col+'66');
      ctx.fillStyle=eg;
      ctx.beginPath(); ctx.roundRect(-b.hw,-b.hh,b.hw*2,b.hh*2,10); ctx.fill();
      // Ğ”ĞµÑ‚Ğ°Ğ»Ğ¸ ĞºĞ¾Ñ€Ğ¿ÑƒÑĞ°
      ctx.strokeStyle=col+'55'; ctx.lineWidth=1.5;
      for(let i=-2;i<=2;i++){
        ctx.beginPath(); ctx.moveTo(i*b.hw*.35,-b.hh); ctx.lineTo(i*b.hw*.35,b.hh); ctx.stroke();
      }
      // Ğ”Ğ²Ğ¸Ğ³Ğ°Ñ‚ĞµĞ»Ğ¸
      [-b.hw*.6,-b.hw*.2,b.hw*.2,b.hw*.6].forEach(ox=>{
        const glow=ctx.createRadialGradient(ox,b.hh,0,ox,b.hh,10);
        glow.addColorStop(0,col+'ff'); glow.addColorStop(1,'transparent');
        ctx.fillStyle=glow; ctx.beginPath(); ctx.arc(ox,b.hh,10+3*Math.sin(animT*5+ox),0,Math.PI*2); ctx.fill();
      });
      // Ğ›Ğ°Ğ·ĞµÑ€Ğ½Ğ°Ñ Ğ¿ÑƒÑˆĞºĞ°
      ctx.fillStyle=b.laserChargeTimer>0||b.laserFiring?'#ffffff':col+'88';
      ctx.beginPath(); ctx.arc(0,b.hh*.4,8,0,Math.PI*2); ctx.fill();
      // Ğ›Ğ°Ğ·ĞµÑ€Ğ½Ñ‹Ğ¹ Ğ»ÑƒÑ‡
      if(b.laserFiring){
        const lx=b.laserX-b.x;
        ctx.save(); ctx.globalAlpha=.7+.3*Math.sin(animT*20);
        const lg=ctx.createLinearGradient(lx,b.hh*.4,lx,canvas.height);
        lg.addColorStop(0,'#ffffff'); lg.addColorStop(.1,col); lg.addColorStop(1,col+'00');
        ctx.fillStyle=lg; ctx.fillRect(lx-6, b.hh*.4, 12, canvas.height);
        ctx.restore();
      }
      // ĞŸÑ€Ğ¸Ñ†ĞµĞ» Ğ»Ğ°Ğ·ĞµÑ€Ğ°
      if(b.laserChargeTimer>0){
        const lx=b.laserX-b.x;
        ctx.save(); ctx.globalAlpha=.4*(1-b.laserChargeTimer/600)*2;
        ctx.strokeStyle='#ffffff'; ctx.lineWidth=2; ctx.setLineDash([5,5]);
        ctx.beginPath(); ctx.moveTo(lx,b.hh*.4); ctx.lineTo(lx,canvas.height); ctx.stroke();
        ctx.setLineDash([]); ctx.restore();
      }
    }
  },

  // 4 â€” Ğ¤Ğ•ĞĞ˜ĞšĞ¡ (ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ 25+): Ğ²Ğ¾Ğ·Ñ€Ğ¾Ğ¶Ğ´Ğ°ĞµÑ‚ÑÑ 1 Ñ€Ğ°Ğ·, Ğ¼ĞµĞ½ÑĞµÑ‚ Ñ„Ğ°Ğ·Ñƒ
  {
    id:'phoenix', name:'ğŸ”¥ Ğ¤Ğ•ĞĞ˜ĞšĞ¡', color:'#ff4400',
    hw:58, hh:52,
    init(b){ b.dir=1; b.shootTimer=0; b.orbAngle=0; b.orbits=[]; b.reborn=false; b.phase=1;
      // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‘Ğ¼ Ğ¾Ñ€Ğ±Ğ¸Ñ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ½Ğ°Ñ€ÑĞ´Ñ‹
      b.orbits=[0,1,2].map(i=>({angle:i/3*Math.PI*2, dist:90+i*15}));
    },
    update(b,dt){
      // Ğ¤Ğ¸Ğ³ÑƒÑ€Ğ°-8 Ğ´Ğ²Ğ¸Ğ¶ĞµĞ½Ğ¸Ğµ
      const t=Date.now()/1500;
      b.x = canvas.width/2 + Math.sin(t)*(canvas.width*.3);
      if(b.y<100) b.y+=1.5; else b.y=100 + Math.sin(t*1.3)*20;
      b.orbAngle += dt*.0025;
      // ĞÑ€Ğ±Ğ¸Ñ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑĞ½Ğ°Ñ€ÑĞ´Ñ‹ Ğ´Ğ²Ğ¸Ğ¶ÑƒÑ‚ÑÑ Ğ²Ğ¾ĞºÑ€ÑƒĞ³ Ğ¸ Ğ´Ğ°Ğ¼Ğ°Ğ¶Ğ°Ñ‚ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ°
      b.orbits.forEach(o=>{
        o.angle += dt*.002;
        const ox=b.x+Math.cos(o.angle)*o.dist;
        const oy=b.y+Math.sin(o.angle)*o.dist;
        if(Math.hypot(ox-player.x,oy-player.y)<20){
          if(activePowerups.shield>0){ activePowerups.shield=0; notify('ğŸ›¡ï¸ Ğ©Ğ˜Ğ¢ Ğ¡Ğ›ĞĞœĞĞ'); updatePowerupBar(); }
          else { lives--; updateHUD(); if(lives<=0) endGame(); }
          o.angle+=Math.PI; // Ğ¾Ñ‚ÑĞºĞ¾Ğº
        }
      });
      b.shootTimer-=dt;
      if(b.shootTimer<=0){
        b.shootTimer = Math.max(600, 1400-level*60);
        if(b.phase===1){
          // Ğ¡Ğ¿Ğ¸Ñ€Ğ°Ğ»ÑŒ
          for(let i=0;i<5;i++){
            const ang=b.orbAngle+i/5*Math.PI*2;
            spawnBossShot(b.x, b.y, Math.cos(ang)*2.8, Math.sin(ang)*2.8, '#ff4400', 9);
          }
        } else {
          // Ğ¤Ğ°Ğ·Ğ° 2 (Ğ¿Ğ¾ÑĞ»Ğµ Ğ²Ğ¾Ğ·Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ñ): Ğ°Ğ³Ñ€ĞµÑÑĞ¸Ğ²Ğ½ĞµĞµ â€” 10 ÑĞ½Ğ°Ñ€ÑĞ´Ğ¾Ğ²
          for(let i=0;i<10;i++){
            const ang=b.orbAngle+i/10*Math.PI*2;
            spawnBossShot(b.x, b.y, Math.cos(ang)*3.5, Math.sin(ang)*3.5, '#ffaa00', 8);
          }
        }
      }
      // Ğ’Ğ¾Ğ·Ñ€Ğ¾Ğ¶Ğ´ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¸ 0 HP Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ² killEnemy
    },
    draw(b,ctx,animT){
      const col = b.phase===2 ? '#ffaa00' : '#ff4400';
      // ĞšÑ€Ñ‹Ğ»ÑŒÑ
      for(let side of [-1,1]){
        ctx.save();
        ctx.fillStyle=col+(b.phase===2?'cc':'88');
        ctx.beginPath();
        ctx.moveTo(0,-b.hh*.2);
        ctx.quadraticCurveTo(side*b.hw*.8,-b.hh*.8, side*b.hw*1.1,-b.hh*.1);
        ctx.quadraticCurveTo(side*b.hw*.7, b.hh*.5, 0,b.hh*.3);
        ctx.closePath(); ctx.fill(); ctx.restore();
      }
      // Ğ¢ĞµĞ»Ğ¾
      const eg=ctx.createRadialGradient(0,0,0,0,0,b.hw*.55);
      eg.addColorStop(0,col+'ff'); eg.addColorStop(.5,col+'cc'); eg.addColorStop(1,col+'22');
      ctx.fillStyle=eg;
      ctx.beginPath(); ctx.arc(0,0,b.hw*.55,0,Math.PI*2); ctx.fill();
      // Ğ¥Ğ²Ğ¾ÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ğ¿ĞµÑ€ÑŒÑ
      for(let i=-2;i<=2;i++){
        ctx.save(); ctx.translate(i*10, b.hh*.4);
        const fl=ctx.createLinearGradient(0,0,0,25+10*Math.sin(animT*4+i));
        fl.addColorStop(0,col+'cc'); fl.addColorStop(1,'transparent');
        ctx.fillStyle=fl;
        ctx.beginPath(); ctx.moveTo(-4,0); ctx.lineTo(4,0); ctx.lineTo(0,25+10*Math.sin(animT*4+i)); ctx.closePath(); ctx.fill();
        ctx.restore();
      }
      // ĞÑ€Ğ±Ğ¸Ñ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑˆĞ°Ñ€Ñ‹
      b.orbits.forEach(o=>{
        const ox=Math.cos(o.angle)*o.dist, oy=Math.sin(o.angle)*o.dist;
        ctx.save();
        ctx.shadowBlur=15; ctx.shadowColor=col;
        ctx.fillStyle=col; ctx.beginPath(); ctx.arc(ox,oy,7,0,Math.PI*2); ctx.fill();
        ctx.restore();
      });
      // Ğ“Ğ»Ğ°Ğ·
      ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(0,-8,7,0,Math.PI*2); ctx.fill();
      ctx.fillStyle=b.phase===2?'#ff8800':'#cc2200';
      ctx.beginPath(); ctx.arc(0,-8,4,0,Math.PI*2); ctx.fill();
    }
  },
];

// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ â€” ÑĞ¿Ğ°Ğ²Ğ½ ÑĞ½Ğ°Ñ€ÑĞ´Ğ° Ğ±Ğ¾ÑÑĞ°
function spawnBossShot(x, y, vx, vy, color, size){
  if(particles.length >= MAX_PARTICLES) return;
  particles.push({x,y,vx,vy,life:1,decay:.005,color,bossShot:true,wave:false,size});
}

// Ğ’Ñ‹Ğ±Ğ¾Ñ€ Ñ‚Ğ¸Ğ¿Ğ° Ğ±Ğ¾ÑÑĞ° Ğ¿Ğ¾ ÑƒÑ€Ğ¾Ğ²Ğ½Ñ
function getBossType(){
  if(level>=25) return BOSS_TYPES[4]; // Ğ¤ĞµĞ½Ğ¸ĞºÑ
  if(level>=20) return BOSS_TYPES[3]; // Ğ”Ñ€ĞµĞ´Ğ½Ğ¾ÑƒÑ‚
  if(level>=15) return BOSS_TYPES[2]; // ĞÑÑŒĞ¼Ğ¸Ğ½Ğ¾Ğ³
  if(level>=10) return BOSS_TYPES[1]; // Ğ¡Ğ½Ğ°Ğ¹Ğ¿ĞµÑ€
  return BOSS_TYPES[0];               // Ğ¡Ñ‚Ñ€Ğ°Ğ¶
}

function spawnBoss(){
  bossActive=true;
  const cfg=DIFF[difficulty];
  const btype=getBossType();
  const hp = Math.floor((30 + level*10 + Math.sqrt(level)*20) * cfg.bossHpMult);
  bossEnemy={
    x:canvas.width/2, y:-80,
    hw:btype.hw, hh:btype.hh,
    sp:1+level*.07,
    hp, maxHp:hp,
    isBoss:true,
    bossType:btype,
    bossId:btype.id,
  };
  btype.init(bossEnemy);
  enemies.push(bossEnemy);
  document.getElementById('bossBar').style.display='block';
  document.getElementById('bossName').textContent=btype.name;
  notify(btype.name+' ĞŸĞĞ¯Ğ’Ğ˜Ğ›Ğ¡Ğ¯!','boss');
  playSound('boss');
  triggerShake(14);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ENEMY SPAWNING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function spawnEnemy(){
  const cfg=DIFF[difficulty];
  const rand=Math.random();
  let type='normal';
  if(rand<.15+level*.02) type='fast';
  else if(rand<.25+level*.01&&level>=3) type='tank';
  else if(rand<.32&&level>=5) type='zigzag';

  const hw=type==='tank'?22:type==='fast'?12:14+Math.random()*8;
  const hh=hw*(.8+Math.random()*.4);
  const hp=type==='tank'?3+Math.floor(level/2):1+Math.floor(level/4);
  const spd=type==='fast'?2.5:type==='tank'?.6:1;

  enemies.push({x:hw+Math.random()*(canvas.width-hw*2),y:-hh*2,hw,hh,sp:(spd+level*.18+Math.random()*.9)*cfg.spd,hp,maxHp:hp,type,zigAngle:0,isBoss:false});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMBO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addCombo(){
  combo = Math.min(combo+1,20);
  if(combo>maxCombo) maxCombo=combo;
  comboTimer = 2500;
  const el = document.getElementById('comboDisplay');
  document.getElementById('comboVal').textContent = 'x'+combo;
  el.classList.toggle('combo-hidden', combo<2);
  if(combo>=5) checkAch('combo5');
  if(combo>=10) checkAch('combo10');
  // Save max combo for dragon skin
  const prev = +LS.get('maxComboEver',0);
  if(combo > prev) LS.set('maxComboEver', combo);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let touching=false;
canvas.addEventListener('touchstart',e=>{e.preventDefault();if(!gameRunning)return;touching=true;player.targetX=e.touches[0].clientX;},{passive:false});
canvas.addEventListener('touchmove', e=>{e.preventDefault();if(!gameRunning)return;player.targetX=e.touches[0].clientX;},{passive:false});
canvas.addEventListener('touchend',  e=>{e.preventDefault();touching=false;},{passive:false});
const keys={};
document.addEventListener('keydown',e=>{keys[e.key]=true;if(e.key===' ')e.preventDefault();if(e.key==='Escape'&&gameRunning){ if(!gamePaused){gamePaused=true;document.getElementById('pauseOverlay').style.display='flex';}else{document.getElementById('resumeBtn').click();} }});
document.addEventListener('keyup',  e=>keys[e.key]=false);

function update(dt){
  const cfg = DIFF[difficulty];
  const bonus = getBonus();
  const moveSpd = activePowerups.speed>0 ? 9 : 6;

  // Player movement
  if(touching){ const dx=player.targetX-player.x; player.x+=dx*.2; }
  if(keys['ArrowLeft']||keys['a']||keys['A']) player.x -= moveSpd;
  if(keys['ArrowRight']||keys['d']||keys['D']) player.x += moveSpd;
  if(keys[' ']&&!autoShoot) shoot();
  player.x = Math.max(player.w/2, Math.min(canvas.width-player.w/2, player.x));
  if(autoShoot) shoot();

  // Player trail
  playerTrail.push({x:player.x, y:player.y+player.h/2, life:1});
  if(playerTrail.length>18) playerTrail.shift();
  playerTrail.forEach(t=>t.life-=.06);

  // Screen shake decay
  if(shakeAmount>0){
    shakeAmount*=.72; shakeX=(Math.random()-.5)*shakeAmount; shakeY=(Math.random()-.5)*shakeAmount;
    if(shakeAmount<.5){shakeAmount=0;shakeX=0;shakeY=0;}
  }

  // Powerup timers
  if(activePowerups.shield>0){ activePowerups.shield-=dt; if(activePowerups.shield<0)activePowerups.shield=0; updatePowerupBar(); }
  if(activePowerups.speed>0){  activePowerups.speed-=dt;  if(activePowerups.speed<0) activePowerups.speed=0;  updatePowerupBar(); }

  // Combo timer
  if(comboTimer>0) comboTimer-=dt;
  else if(combo>1){ combo=1; document.getElementById('comboDisplay').classList.add('combo-hidden'); }

  // Background scroll
  stars.forEach(s=>{s.y+=s.sp;if(s.y>canvas.height){s.y=0;s.x=Math.random()*canvas.width;}});
  nebulas.forEach(n=>{n.y+=n.sp;if(n.y>canvas.height+n.r){n.y=-n.r;n.x=Math.random()*canvas.width;}});
  planets.forEach(p=>{p.y+=p.sp;if(p.y>canvas.height+p.r+50){p.y=-p.r-50;p.x=Math.random()*canvas.width;}});
  asteroids.forEach(a=>{a.y+=a.sp;a.angle+=a.rot;if(a.y>canvas.height+30){a.y=-30;a.x=Math.random()*canvas.width;}});

  // Bullets
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    b.y-=b.sp;
    if(b.vx) b.x+=b.vx;
    if(b.type==='rocket'&&b.homing&&enemies.length>0){
      // Find nearest enemy
      let nearest=null, nearDist=Infinity;
      enemies.forEach(e=>{ const d=Math.hypot(e.x-b.x,e.y-b.y); if(d<nearDist){nearDist=d;nearest=e;} });
      if(nearest){
        const dx=nearest.x-b.x, dy=nearest.y-b.y, dist=Math.max(nearDist,.1);
        b.x+=dx/dist*2.5; b.y+=dy/dist*2.5-b.sp;
        b.angle=Math.atan2(dx,-(dy-b.sp*dist))*0.5;
      }
    }
    if(b.y<-50||b.x<-30||b.x>canvas.width+30||b.y>canvas.height+30) bullets.splice(i,1);
  }

  // Powerup objects
  for(let i=powerups.length-1;i>=0;i--){
    const p=powerups[i];
    if(bonus.magnetRadius>0){
      const dx=player.x-p.x, dy=player.y-p.y, dist=Math.hypot(dx,dy);
      if(dist<bonus.magnetRadius){ p.x+=dx/dist*4.5; p.y+=dy/dist*4.5; }
    }
    p.y+=p.sp; p.angle+=.05; p.life-=p.decay;
    if(p.y>canvas.height+20||p.life<=0){ powerups.splice(i,1); continue; }
    if(Math.abs(p.x-player.x)<(p.r+player.w/2)&&Math.abs(p.y-player.y)<(p.r+player.h/2)){
      applyPowerup(p.type); powerups.splice(i,1);
    }
  }

  // Enemies
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    if(e.isBoss){
      e.bossType.update(e, dt);
      document.getElementById('bossFill').style.width=(e.hp/e.maxHp*100)+'%';
    }else{
      e.y+=e.sp;
      if(e.type==='zigzag'){ e.zigAngle+=.08; e.x+=Math.sin(e.zigAngle)*3; }
    }
    if(e.y>canvas.height+80){
      if(e.isBoss){ bossActive=false; bossEnemy=null; document.getElementById('bossBar').style.display='none'; }
      else { lives--; updateHUD(); if(lives<=0){endGame();return;} }
      enemies.splice(i,1);
    }
  }

  // â”€â”€ Bullet â†” Enemy collisions â”€â”€
  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i];
    if(!b) continue;
    let hit=false;
    for(let j=enemies.length-1;j>=0;j--){
      const e=enemies[j];
      if(!e) continue;
      // Shotgun pierce: skip already-hit enemies
      if(b.pierce && b.pierced && b.pierced.has(j)) continue;
      const hitW=b.type==='rocket'?e.hw+12:e.hw, hitH=b.type==='rocket'?e.hh+12:e.hh;
      if(b.x>e.x-hitW&&b.x<e.x+hitW&&b.y>e.y-hitH&&b.y<e.y+hitH){
        if(b.type==='rocket'){
          explode(b.x,b.y,'#ff6b00',45); triggerShake(12); playSound('explode');
          enemies.forEach((en,idx)=>{ if(Math.hypot(en.x-b.x,en.y-b.y)<80) en.hp-=Math.ceil((b.dmg||1)*1.5); });
          bullets.splice(i,1); hit=true;
        }else if(b.pierce){
          b.pierced.add(j);
          e.hp-=Math.ceil(b.dmg||1);
          playSound('hit');
        }else{
          bullets.splice(i,1); hit=true;
          e.hp-=Math.ceil(b.dmg||1);
          playSound('hit');
        }
        if(e.hp<=0) killEnemy(j, cfg);
        if(hit) break;
      }
    }
  }
  // Remove dead shotgun bullets
  for(let i=bullets.length-1;i>=0;i--){ if(bullets[i]&&bullets[i].pierce&&bullets[i].y<-50) bullets.splice(i,1); }

  // Boss shots â†” player
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    if(!p.bossShot) continue;
    if(Math.abs(p.x-player.x)<player.w/2&&Math.abs(p.y-player.y)<player.h/2){
      particles.splice(i,1);
      if(activePowerups.shield>0){ activePowerups.shield=0; notify('ğŸ›¡ï¸ Ğ©Ğ˜Ğ¢ Ğ¡Ğ›ĞĞœĞĞ'); updatePowerupBar(); }
      else{ lives--; updateHUD(); if(lives<=0){endGame();return;} playSound('hit'); triggerShake(10); }
    }
  }

  // Enemy â†” player collisions
  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    if(Math.abs(e.x-player.x)<(e.hw+player.w*.45)&&Math.abs(e.y-player.y)<(e.hh+player.h*.45)){
      if(activePowerups.shield>0){
        explode(e.x,e.y,'#00d4ff',20); enemies.splice(i,1);
        activePowerups.shield=0; notify('ğŸ›¡ï¸ Ğ©Ğ˜Ğ¢ Ğ¡Ğ›ĞĞœĞĞ'); updatePowerupBar(); playSound('hit');
      }else{
        explode(player.x,player.y,(SKIN_COLORS[activeSkin]||SKIN_COLORS.default).a);
        if(!e.isBoss) enemies.splice(i,1);
        lives--; updateHUD(); if(lives<=0){endGame();return;}
        playSound('hit'); triggerShake(12);
      }
    }
  }

  // Particles
  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i];
    p.x+=p.vx||0; p.y+=p.vy||0;
    p.life-=p.decay;
    if(p.wave&&p.r!==undefined) p.r=p.maxR*(1-p.life);
    if(p.life<=0) particles.splice(i,1);
  }

  // Spawn enemies
  if(!bossActive && Math.random()<cfg.spawn+level*.0025) spawnEnemy();
}

function killEnemy(j, cfg){
  const e=enemies[j];
  if(!e) return;
  if(e.isBoss){
    // Ğ¤ĞµĞ½Ğ¸ĞºÑ â€” Ğ²Ğ¾Ğ·Ñ€Ğ¾Ğ¶Ğ´Ğ°ĞµÑ‚ÑÑ Ğ¾Ğ´Ğ¸Ğ½ Ñ€Ğ°Ğ·
    if(e.bossId==='phoenix' && !e.reborn){
      e.reborn=true; e.phase=2;
      e.hp=Math.floor(e.maxHp*.6);
      explode(e.x,e.y,'#ff4400',40); triggerShake(14); playSound('explode');
      notify('ğŸ”¥ Ğ¤Ğ•ĞĞ˜ĞšĞ¡ Ğ’ĞĞ—Ğ ĞĞ–Ğ”ĞĞ•Ğ¢Ğ¡Ğ¯!','boss');
      // ĞÑ€Ğ±Ğ¸Ñ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ÑˆĞ°Ñ€Ñ‹ ÑƒÑĞºĞ¾Ñ€ÑÑÑ‚ÑÑ
      return; // Ğ½Ğµ ÑƒĞ¼Ğ¸Ñ€Ğ°ĞµÑ‚
    }
    const col=e.bossType.color;
    explode(e.x,e.y,col,60); triggerShake(20); playSound('explode');
    bossActive=false; bossEnemy=null; document.getElementById('bossBar').style.display='none';
    bossesKilled++;
    const pts = 500*level;
    score+=pts; levelProgress+=pts;
    LS.set('totalBosses',(+LS.get('totalBosses',0))+1);
    notify(e.bossType.name+' Ğ£ĞĞ˜Ğ§Ğ¢ĞĞ–Ğ•Ğ! +'+pts,'boss');
    checkAch('boss1');
  }else{
    const col=e.type==='fast'?'#00d4ff':e.type==='tank'?'#a855f7':'#ff6b00';
    explode(e.x,e.y,col); triggerShake(4);
  }
  enemies.splice(j,1);
  killedEnemies++;
  LS.set('totalKills',(+LS.get('totalKills',0))+1);
  if(killedEnemies===1) checkAch('first_kill');
  addCombo();

  const pts = Math.floor((e.isBoss?500:10)*level*DIFF[difficulty].scoreMult*combo);
  score+=pts; levelProgress+=pts;

  const earnedCoins = Math.floor((e.isBoss?15:1)*level*(combo>5?2:1));
  coins+=earnedCoins;
  addShipXP(Math.floor((e.isBoss?100:10)*level));
  savePersistent();

  if(Math.random()<DIFF[difficulty].powerupRate&&!e.isBoss) spawnPowerup(e.x,e.y);

  if(combo>1) notify('+'+pts+' x'+combo,'gold');
  else notify('+'+pts,'gold');

  if(score>=1000) checkAch('score1000');
  if(score>=5000) checkAch('score5000');
  if(level>=5) checkAch('survive5');

  updateHUD();

  const threshold = 150 + level*80 + level*level*5;
  if(levelProgress>=threshold){
    level++; levelProgress=0;
    notify('â¬†ï¸ Ğ£Ğ ĞĞ’Ğ•ĞĞ¬ '+level,'levelup');
    playSound('levelup');
    if(level%5===0&&!bossActive) spawnBoss();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DRAW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function draw(){
  const skinC = SKIN_COLORS[activeSkin] || SKIN_COLORS.default;
  ctx.save();
  if(shakeAmount>0) ctx.translate(shakeX, shakeY);

  // Background
  const bg=ctx.createLinearGradient(0,0,0,canvas.height);
  bg.addColorStop(0,'#040410'); bg.addColorStop(.5,'#0e0420'); bg.addColorStop(1,'#040410');
  ctx.fillStyle=bg; ctx.fillRect(0,0,canvas.width,canvas.height);

  // Nebulas
  nebulas.forEach(n=>{
    const g=ctx.createRadialGradient(n.x,n.y,0,n.x,n.y,n.r);
    g.addColorStop(0,`hsla(${n.hue},80%,60%,${n.o})`); g.addColorStop(1,'transparent');
    ctx.fillStyle=g; ctx.fillRect(n.x-n.r,n.y-n.r,n.r*2,n.r*2);
  });

  // Planets
  planets.forEach(p=>{
    ctx.save(); ctx.globalAlpha=p.o;
    const pg=ctx.createRadialGradient(p.x-p.r*.3,p.y-p.r*.3,0,p.x,p.y,p.r);
    pg.addColorStop(0,`hsl(${p.hue},60%,55%)`); pg.addColorStop(.6,`hsl(${p.hue},50%,30%)`); pg.addColorStop(1,`hsl(${p.hue},40%,10%)`);
    ctx.fillStyle=pg; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    if(p.rings){
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.ringAngle); ctx.scale(1,.3);
      ctx.strokeStyle=`hsla(${p.hue},60%,70%,.5)`; ctx.lineWidth=4;
      ctx.beginPath(); ctx.arc(0,0,p.r*1.5,0,Math.PI*2); ctx.stroke();
      ctx.strokeStyle=`hsla(${p.hue},60%,70%,.3)`; ctx.lineWidth=8;
      ctx.beginPath(); ctx.arc(0,0,p.r*1.8,0,Math.PI*2); ctx.stroke();
      ctx.restore();
    }
    ctx.restore();
  });

  // Asteroids
  asteroids.forEach(a=>{
    ctx.save(); ctx.globalAlpha=.5; ctx.translate(a.x,a.y); ctx.rotate(a.angle);
    ctx.fillStyle='#554433'; ctx.strokeStyle='#776655'; ctx.lineWidth=1.5;
    ctx.beginPath();
    a.pts.forEach((p,i)=>{ const px=Math.cos(p.a)*a.r*p.r, py=Math.sin(p.a)*a.r*p.r; i===0?ctx.moveTo(px,py):ctx.lineTo(px,py); });
    ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.restore();
  });

  // Stars (flickering)
  const t=Date.now()/1000;
  stars.forEach(s=>{
    const f=.7+.3*Math.sin(t*s.sp*3+s.x);
    ctx.fillStyle=`rgba(255,255,255,${s.o*f})`; ctx.fillRect(s.x,s.y,s.s,s.s);
  });

  // Player trail
  playerTrail.forEach(pt=>{
    if(pt.life<=0) return;
    ctx.save(); ctx.globalAlpha=pt.life*.45;
    ctx.fillStyle=skinC.trail; ctx.shadowBlur=8; ctx.shadowColor=skinC.glow;
    const sz=6*pt.life; ctx.beginPath(); ctx.arc(pt.x,pt.y,sz,0,Math.PI*2); ctx.fill();
    ctx.restore();
  });

  // Powerup items
  powerups.forEach(p=>{
    ctx.save(); ctx.globalAlpha=p.life; ctx.translate(p.x,p.y); ctx.rotate(p.angle);
    const col=p.type==='shield'?'#00d4ff':p.type==='speed'?'#ffd700':'#ff6b00';
    ctx.shadowBlur=20; ctx.shadowColor=col;
    ctx.fillStyle=col+'33'; ctx.beginPath(); ctx.arc(0,0,p.r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle=col; ctx.lineWidth=2; ctx.stroke();
    ctx.font=`${p.r}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.shadowBlur=0; ctx.fillStyle='white'; ctx.fillText(p.icon,0,2);
    ctx.restore();
  });

  // Player ship
  ctx.save();
  if(custom.glow){ ctx.shadowBlur=24; ctx.shadowColor=skinC.glow; }
  const sg=ctx.createLinearGradient(player.x-player.w/2,player.y-player.h/2,player.x+player.w/2,player.y+player.h/2);
  sg.addColorStop(0,skinC.a); sg.addColorStop(1,skinC.b);
  ctx.fillStyle=sg; ctx.beginPath();
  const sh=custom.shipShape;
  if(sh==='fighter'){
    ctx.moveTo(player.x,player.y-player.h/2);
    ctx.lineTo(player.x-player.w/2,player.y+player.h/2);
    ctx.lineTo(player.x,player.y+player.h/4);
    ctx.lineTo(player.x+player.w/2,player.y+player.h/2);
  }else if(sh==='arrow'){
    ctx.moveTo(player.x,player.y-player.h/2);
    ctx.lineTo(player.x-player.w/3,player.y+player.h/3);
    ctx.lineTo(player.x-player.w/2,player.y+player.h/2);
    ctx.lineTo(player.x,player.y+player.h/6);
    ctx.lineTo(player.x+player.w/2,player.y+player.h/2);
    ctx.lineTo(player.x+player.w/3,player.y+player.h/3);
  }else{
    ctx.moveTo(player.x,player.y-player.h/2);
    ctx.lineTo(player.x-player.w/2,player.y);
    ctx.lineTo(player.x,player.y+player.h/2);
    ctx.lineTo(player.x+player.w/2,player.y);
  }
  ctx.closePath(); ctx.fill();
  // Shield ring
  if(activePowerups.shield>0){
    ctx.strokeStyle='#00d4ff88'; ctx.lineWidth=3; ctx.shadowBlur=16; ctx.shadowColor='#00d4ff';
    ctx.beginPath(); ctx.arc(player.x,player.y,player.w*.9,0,Math.PI*2); ctx.stroke();
  }
  // Engine flame
  const flame=ctx.createLinearGradient(player.x,player.y+player.h/2,player.x,player.y+player.h/2+22);
  flame.addColorStop(0,skinC.a+'cc'); flame.addColorStop(1,'transparent');
  ctx.fillStyle=flame; ctx.shadowBlur=0;
  ctx.beginPath();
  ctx.moveTo(player.x-9,player.y+player.h/2);
  ctx.lineTo(player.x+9,player.y+player.h/2);
  ctx.lineTo(player.x,player.y+player.h/2+14+Math.random()*10);
  ctx.closePath(); ctx.fill();
  ctx.restore();

  // Bullets
  bullets.forEach(b=>{
    ctx.save();
    const wc=b.type==='rocket'?{a:'#ff6b00',b:'#ffaa00'}:b.type==='shotgun'?{a:'#ffd700',b:'#ff9900'}:BULLET_COLORS[custom.bulletColor];
    if(custom.glow){ ctx.shadowBlur=b.type==='rocket'?18:12; ctx.shadowColor=wc.a; }
    if(b.type==='rocket'){
      ctx.translate(b.x,b.y); ctx.rotate(b.angle||0);
      const rg=ctx.createLinearGradient(0,-b.h/2,0,b.h/2);
      rg.addColorStop(0,wc.a); rg.addColorStop(1,wc.b);
      ctx.fillStyle=rg; ctx.beginPath(); ctx.roundRect(-b.w/2,-b.h/2,b.w,b.h,4); ctx.fill();
      ctx.fillStyle=wc.a+'55'; ctx.beginPath();
      ctx.moveTo(-b.w/2,b.h/2); ctx.lineTo(b.w/2,b.h/2); ctx.lineTo(0,b.h/2+9+Math.random()*6); ctx.closePath(); ctx.fill();
    }else{
      const bg2=ctx.createLinearGradient(b.x,b.y,b.x,b.y+b.h);
      bg2.addColorStop(0,wc.a); bg2.addColorStop(1,wc.b);
      ctx.fillStyle=bg2; ctx.beginPath(); ctx.roundRect(b.x-b.w/2,b.y,b.w,b.h,3); ctx.fill();
    }
    ctx.restore();
  });

  // Enemies
  const animT=Date.now()/400;
  enemies.forEach(e=>{
    ctx.save();
    if(e.isBoss){
      const col=e.bossType.color;
      const pulse=1+.05*Math.sin(animT*2);
      ctx.translate(e.x,e.y); ctx.scale(pulse,pulse);
      if(custom.glow){ ctx.shadowBlur=30; ctx.shadowColor=col; }
      e.bossType.draw(e,ctx,animT);
      // HP bar for boss (above)
      if(e.hp<e.maxHp){
        const bw=e.hw*2,bh=5,by=-e.hh-18;
        ctx.fillStyle='rgba(0,0,0,.6)'; ctx.fillRect(-e.hw,by,bw,bh);
        const pct=e.hp/e.maxHp;
        ctx.fillStyle=pct>.5?'#00ff88':pct>.25?'#ff9900':'#ff0066';
        ctx.fillRect(-e.hw,by,bw*pct,bh);
      }
    }else{
      const col=e.type==='fast'?'#00d4ff':e.type==='tank'?'#a855f7':e.type==='zigzag'?'#ffaa00':'#ff2080';
      const pulse=1+.03*Math.sin(animT+e.x*.01);
      ctx.translate(e.x,e.y); ctx.scale(pulse,pulse);
      if(custom.glow){ ctx.shadowBlur=14; ctx.shadowColor=col; }
      const eg=ctx.createRadialGradient(0,0,0,0,0,e.hw);
      eg.addColorStop(0,col+'ff'); eg.addColorStop(.6,col+'aa'); eg.addColorStop(1,col+'22');
      ctx.fillStyle=eg; ctx.beginPath();
      if(e.type==='fast'){
        ctx.moveTo(0,-e.hh); ctx.lineTo(e.hw,0); ctx.lineTo(0,e.hh); ctx.lineTo(-e.hw,0);
        ctx.closePath(); ctx.fill();
        ctx.strokeStyle=col+'88'; ctx.lineWidth=1.5;
        ctx.beginPath(); ctx.moveTo(-e.hw*.5,-e.hh*.3); ctx.lineTo(-e.hw*.5,e.hh*.3); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(e.hw*.5,-e.hh*.3); ctx.lineTo(e.hw*.5,e.hh*.3); ctx.stroke();
      }else if(e.type==='tank'){
        ctx.roundRect(-e.hw,-e.hh,e.hw*2,e.hh*2,6); ctx.fill();
        ctx.strokeStyle=col+'88'; ctx.lineWidth=3;
        ctx.beginPath(); ctx.roundRect(-e.hw*.7,-e.hh*.7,e.hw*1.4,e.hh*1.4,4); ctx.stroke();
      }else{
        for(let a=0;a<6;a++){ const ang=(a/6)*Math.PI*2-Math.PI/6; ctx.lineTo(Math.cos(ang)*e.hw,Math.sin(ang)*e.hh); }
        ctx.closePath(); ctx.fill();
        ctx.fillStyle=col+'44'; ctx.beginPath(); ctx.arc(0,0,e.hw*.4,0,Math.PI*2); ctx.fill();
      }
      // HP bar
      if(e.hp<e.maxHp){
        const bw=e.hw*2,bh=4,by=-e.hh-8;
        ctx.fillStyle='rgba(0,0,0,.55)'; ctx.fillRect(-e.hw,by,bw,bh);
        const pct=e.hp/e.maxHp; ctx.fillStyle=pct>.5?'#00ff88':'#ff6b00';
        ctx.fillRect(-e.hw,by,bw*pct,bh);
      }
    }
    ctx.restore();
  });

  // Particles & waves
  particles.forEach(p=>{
    if(p.bossShot){
      ctx.save();
      ctx.fillStyle=p.color+'aa';
      ctx.shadowBlur=12; ctx.shadowColor=p.color;
      ctx.beginPath(); ctx.arc(p.x,p.y,(p.size||8)/2,0,Math.PI*2); ctx.fill();
      // Inner glow
      ctx.fillStyle=p.color+'ff';
      ctx.beginPath(); ctx.arc(p.x,p.y,(p.size||8)/4,0,Math.PI*2); ctx.fill();
      ctx.restore();
    }else if(p.wave){
      ctx.save(); ctx.globalAlpha=p.life*.5;
      ctx.strokeStyle=p.color; ctx.lineWidth=3; ctx.shadowBlur=15; ctx.shadowColor=p.color;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r||0,0,Math.PI*2); ctx.stroke(); ctx.restore();
    }else{
      const a=Math.floor(p.life*255).toString(16).padStart(2,'0');
      ctx.fillStyle=p.color+a; ctx.fillRect(p.x,p.y,p.size||4,p.size||4);
    }
  });

  ctx.restore(); // end shake
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HUD UPDATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateHUD(){
  document.getElementById('scoreVal').textContent = score;
  document.getElementById('livesVal').textContent = lives;
  document.getElementById('levelVal').textContent = level;
  const threshold = 150 + level*80 + level*level*5;
  document.getElementById('levelFill').style.width = Math.min(100, levelProgress/threshold*100)+'%';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GAME LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loop(ts){
  if(!gameRunning || gamePaused) return;
  const dt = Math.min(ts - lastTime, 50);
  lastTime = ts;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// START / END
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGame(){
  const cfg = DIFF[difficulty];
  const bonus = getBonus();
  score=0; lives=cfg.lives; level=1; levelProgress=0;
  combo=1; maxCombo=1; comboTimer=0;
  killedEnemies=0; bossesKilled=0;
  bossActive=false; bossEnemy=null;
  sessionAch=[];
  activePowerups = {shield: bonus.hasStartShield?9999:0, speed:0};
  bullets.length=0; enemies.length=0; particles.length=0; powerups.length=0;
  playerTrail.length=0;
  player.x=player.targetX=canvas.width/2;
  gamePaused=false;
  gameRunning=true;
  updateHUD(); renderXPBar();
  document.getElementById('bossBar').style.display='none';
  if(activePowerups.shield>0) updatePowerupBar();

  // Touch hint
  const old=document.querySelector('.touch-hint');if(old)old.remove();
  const hint=document.createElement('div');
  hint.className='touch-hint'; hint.textContent='â˜ï¸ Ğ’ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ğ»ÑŒÑ†ĞµĞ¼ â€¢ ESC = Ğ¿Ğ°ÑƒĞ·Ğ°';
  document.body.appendChild(hint); setTimeout(()=>hint.remove(),4500);

  lastTime=performance.now();
  requestAnimationFrame(loop);
}

function endGame(){
  gameRunning=false;
  if(score>bestScore){ bestScore=score; LS.set('bestScore',bestScore); }

  // Update leaderboard
  const myName=tg?.initDataUnsafe?.user?.first_name||'Ğ˜Ğ³Ñ€Ğ¾Ğº';
  const myId=tg?.initDataUnsafe?.user?.id||0;
  let lb=LS.getJ('leaderboard',[]);
  lb=lb.filter(e=>e.id!==myId);
  lb.push({id:myId,name:myName,score:bestScore,lvl:shipLvl});
  lb.sort((a,b)=>b.score-a.score); lb=lb.slice(0,20);
  LS.setJ('leaderboard',lb);

  document.getElementById('goScore').innerHTML = score + (score===bestScore&&score>0?'<span class="new-record">NEW!</span>':'');
  document.getElementById('goLevel').textContent = level;
  document.getElementById('goCombo').textContent = 'x'+maxCombo;
  document.getElementById('goBest').textContent = bestScore;
  document.getElementById('goCoins').textContent = 'ğŸ’° ĞœĞ¾Ğ½ĞµÑ‚ Ğ² ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞµ: '+coins;

  const achEl=document.getElementById('goAch'); achEl.innerHTML='';
  ACHIEVEMENTS.forEach(a=>{
    const b=document.createElement('div');
    b.className='ach-badge '+(unlockedAch.includes(a.id)?'unlocked':'locked');
    b.textContent=a.name; achEl.appendChild(b);
  });

  showScreen('gameOverScreen');
  if(tg?.initDataUnsafe?.user) tg.sendData(JSON.stringify({score,level,difficulty,maxCombo,coins,shipLvl,userId:tg.initDataUnsafe.user.id}));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESIZE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('resize',()=>{
  canvas.width=window.innerWidth; canvas.height=window.innerHeight;
  player.x=player.targetX=canvas.width/2;
});
</script>
</body>
</html>